C
C
C*DK OUTSIG
      SUBROUTINE OUTSIG(ENSAVE)

      USE PRECISION
      USE PARMMOD
      USE COMUSR
      USE CLOGAU
      USE CPLOT
      USE COMSIG
      USE CTEXT

      IMPLICIT NONE

      REAL(DP), INTENT(IN) :: ENSAVE(NCHOR,NCHEN)
      REAL(SP) :: XPLEN(NCHEN), DUMFFS(NCHEN)
      REAL(DP) :: DUMFFD(NCHEN)
      REAL(DP) :: TIMA, DUMTIL, AH, TIMI
      INTEGER :: ICURV, ICHORI, I, NCHNI, IDET, ISK, JSK
      CHARACTER(8) :: TSAFE, TEXTSS
      DATA TEXTSS /'SUM     '/
C
      CALL PAGE
      NCHNI=IABS(NCHENI)
      TSAFE=TEXTS(1)
      IDET=0
      ICURV=0
      DO 100  ICHORI=1,NCHORI
C
C  NEW HEADING ?
        IF (NCHTAL(ICHORI).EQ.IDET) GOTO 102
        IDET=NCHTAL(ICHORI)
        CALL LEER(2)
        IF (NCHTAL(ICHORI).EQ.1) THEN
          CALL HEADNG('CX-DETECTOR SIGNALS, MAXW. NEUTRL. DISTR.',41)
        ELSEIF (NCHTAL(ICHORI).EQ.2) THEN
          CALL HEADNG('H ALPHA-DETECTOR SIGNALS',24)
        ELSEIF (NCHTAL(ICHORI).EQ.3) THEN
          CALL HEADNG('USER DEFINED LINE INTEGRAL (SUBR. SIGUSR)',41)
        ELSE
          CALL HEADNG('LINE INTEGRAL TESTING OPTION: NO SIGNALS)',41)
        ENDIF
        CALL LEER(2)
C
102     CONTINUE
        CALL MASAGE ('NUMBER OF DETECTOR                           ')
        CALL MASJ1 ('ICHORI =',ICHORI)
        WRITE (6,*) TXTSIG(ICHORI)
        CALL LEER(1)
        CALL MASR3 ('1ST POINT,"PIVOT POINT" ',
     .               XPIVOT(ICHORI),YPIVOT(ICHORI),ZPIVOT(ICHORI))
        CALL MASR3 ('2ND POINT, INSIDE VOLUME',
     .               XCHORD(ICHORI),YCHORD(ICHORI),ZCHORD(ICHORI))
        DO 30 I=1,NCHNI
          ENERGY(I)=ENSAVE(ICHORI,I)
30      CONTINUE
C
C
        IF (NCHTAL(ICHORI).EQ.1.OR.NCHTAL(ICHORI).EQ.3) THEN
C
          IF (NSPSPZ(ICHORI).EQ.0) THEN
            TEXTS(1)=TEXTSS
          ENDIF
C
          DUMTIL=TILINE(ICHORI)
          DO 70 I=1,NCHNI
            AH=FUFFER(ICHORI,I)
            DUMFFS(I)=MAX(1.E-10_DP,AH)
            DUMFFD(I)=MAX(1.E-10_DP,AH)
            XPLEN(I)=ENERGY(I)
70        CONTINUE
          CALL MASRR2('ENERGY,CXFLUX         ',ENERGY,DUMFFD,NCHNI)
          CALL MASR1('INP. TEM.',TINP(ICHORI))
          CALL MASR1('DT. TMP.',DUMTIL)
          CALL MASAGE ('FITTING RANGE:  TIMIN,TIMAX=                 ')
          TIMI=NSPINI(ICHORI)*TINP(ICHORI)
          TIMA=NSPEND(ICHORI)*TINP(ICHORI)
          CALL MASR2 ('TIMIN,TIMAX=    ',TIMI,TIMA)
          CALL LEER(2)
C
C  PREPARE DATA FOR PLOT OF SPECTRUM NO ICHORI
          IF (PLSPEC) THEN
C  CLOSE OLD PICTURE
            IF (NSPNEW(ICHORI).EQ.1.AND.ICURV.GT.0) THEN
              CALL GRBLD(33.,24.,ISK,JSK,666.,666.,666.,666.,ICURV)
              ICURV=0
            ENDIF
C  INITALIZE NEW PICTURE
            IF (NSPNEW(ICHORI).EQ.1) THEN
              IF (NSPSCL(ICHORI).EQ.0) THEN
                ISK=101
                JSK=101
              ELSEIF (NSPSCL(ICHORI).EQ.1) THEN
                ISK=101
                JSK=-101
              ELSEIF (NSPSCL(ICHORI).EQ.2) THEN
                ISK=-101
                JSK=101
              ELSEIF (NSPSCL(ICHORI).EQ.3) THEN
                ISK=-101
                JSK=-101
              ENDIF
              CALL GRNXTB(2)
            ENDIF
C  PLOT
            ICURV=ICURV+1
            CALL KURVEF(XPLEN,DUMFFS,NCHNI,116)
          ENDIF
C
          TEXTS(1)=TSAFE
C
        ELSEIF (NCHTAL(ICHORI).EQ.2) THEN
C
          DUMTIL=FUFFER(ICHORI,1)
          CALL MASR1('H ALPHA ',DUMTIL)
          CALL LEER(2)
        ENDIF
100   CONTINUE
      CALL LEER(2)
C
C  FINISH PLOT
C
      IF (PLSPEC.AND.ICURV.GT.0) THEN
        CALL GRBLD(33.,24.,ISK,JSK,666.,666.,666.,666.,ICURV)
      ENDIF
      RETURN
      END
