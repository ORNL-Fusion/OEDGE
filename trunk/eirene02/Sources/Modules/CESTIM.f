      MODULE CESTIM

      USE PRECISION
      USE PARMMOD

      IMPLICIT NONE

      PRIVATE

      PUBLIC :: ALLOC_CESTIM, DEALLOC_CESTIM, ASSOCIATE_CESTIM,
     P          INIT_CESTIM

      INTEGER, PUBLIC, SAVE ::
     I NESTM1, NESTM2, NESTIM

      REAL(DP), PUBLIC, TARGET, ALLOCATABLE, SAVE ::
     R        ESTIMV(:,:), ESTIMS(:,:)

C  NESTM1, REAL, VOLUME AVERAGED TALLIES
      REAL(DP), PUBLIC, POINTER, SAVE ::
     R PDENA(:,:), PDENM(:,:), PDENI(:,:),
     R EDENA(:,:), EDENM(:,:), EDENI(:,:),
     R PAEL(:),    PAAT(:,:),  PAML(:,:),  PAIO(:,:), PAPL(:,:),
     R PMEL(:),    PMAT(:,:),  PMML(:,:),  PMIO(:,:), PMPL(:,:),
     R PIEL(:),    PIAT(:,:),  PIML(:,:),  PIIO(:,:), PIPL(:,:),
     R EAEL(:),    EAAT(:),    EAML(:),    EAIO(:),   EAPL(:),
     R EMEL(:),    EMAT(:),    EMML(:),    EMIO(:),   EMPL(:),
     R EIEL(:),    EIAT(:),    EIML(:),    EIIO(:),   EIPL(:),
     R ADDV(:,:),  COLV(:,:),  SNAPV(:,:),
     R COPV(:,:),  BGKV(:,:),  ALGV(:,:),
     R PGENA(:,:), PGENM(:,:), PGENI(:,:),
     R EGENA(:,:), EGENM(:,:), EGENI(:,:),
     R VGENA(:,:), VGENM(:,:), VGENI(:,:)

C  NESTM2, REAL, SURFACE AVERAGED TALLIES
      REAL(DP), PUBLIC, POINTER, SAVE ::
     R POTAT(:,:), 
     R PRFAAT(:,:), PRFMAT(:,:), PRFIAT(:,:), PRFPAT(:,:),
C
     R POTML(:,:),
     R PRFAML(:,:), PRFMML(:,:), PRFIML(:,:), PRFPML(:,:),
C
     R POTIO(:,:),
     R PRFAIO(:,:), PRFMIO(:,:), PRFIIO(:,:), PRFPIO(:,:),
C
     R POTPL(:,:),
C
     R EOTAT(:,:),
     R ERFAAT(:,:), ERFMAT(:,:), ERFIAT(:,:), ERFPAT(:,:),
C
     R EOTML(:,:),
     R ERFAML(:,:), ERFMML(:,:), ERFIML(:,:), ERFPML(:,:),
C
     R EOTIO(:,:),
     R ERFAIO(:,:), ERFMIO(:,:), ERFIIO(:,:), ERFPIO(:,:),
C
     R EOTPL(:,:),
C
     R SPTAT(:,:), SPTML(:,:),
     R SPTIO(:,:), SPTPL(:,:),
     R SPTTOT(:),
     R ADDS(:,:),  ALGS(:,:),
     R SPUMP(:,:)

C  FROM HERE: NO EQUIVALENCE
      INTEGER, PUBLIC, ALLOCATABLE, SAVE ::
     I NFIRST(:), NADDV(:),
     I IRESC1(:), IRESC2(:),
     I NFRSTW(:), NADDW(:)
C

      CONTAINS


      SUBROUTINE ALLOC_CESTIM
      
      IF (ALLOCATED(ESTIMV)) RETURN

      NESTM1=NVOLTL*NRTAL
      NESTM2=NSRFTL*NLMPGS
      NESTIM=NESTM1+NESTM2

      ALLOCATE (ESTIMV(NVOLTL,NRTAL))
      ALLOCATE (ESTIMS(NSRFTL,NLMPGS))
      ALLOCATE (NFIRST(NTALV)) 
      ALLOCATE (NADDV(NTALV))
      ALLOCATE (IRESC1(NTALV)) 
      ALLOCATE (IRESC2(NTALV))
      ALLOCATE (NFRSTW(NTALS)) 
      ALLOCATE (NADDW(NTALS))

      WRITE (55,*) ' CESTIM ',NESTIM*8 + (4*NTALV+2*NTALS)*4

      CALL INIT_CESTIM

      RETURN
      END SUBROUTINE ALLOC_CESTIM


      SUBROUTINE ASSOCIATE_CESTIM

C  VOLUME AVERAGED TALLIES

      PDENA => ESTIMV(1:NADDV(2),:)
      PDENM => ESTIMV(NADDV(2)+1:NADDV(3),:)
      PDENI => ESTIMV(NADDV(3)+1:NADDV(4),:)

      EDENA => ESTIMV(NADDV(4)+1:NADDV(5),:)
      EDENM => ESTIMV(NADDV(5)+1:NADDV(6),:)
      EDENI => ESTIMV(NADDV(6)+1:NADDV(7),:)

      PAEL  => ESTIMV(NADDV(8),:)
      PAAT  => ESTIMV(NADDV(8)+1:NADDV(9),:)
      PAML  => ESTIMV(NADDV(9)+1:NADDV(10),:)
      PAIO  => ESTIMV(NADDV(10)+1:NADDV(11),:)
      PAPL  => ESTIMV(NADDV(11)+1:NADDV(12),:)

      PMEL  => ESTIMV(NADDV(13),:)
      PMAT  => ESTIMV(NADDV(13)+1:NADDV(14),:)
      PMML  => ESTIMV(NADDV(14)+1:NADDV(15),:)
      PMIO  => ESTIMV(NADDV(15)+1:NADDV(16),:)
      PMPL  => ESTIMV(NADDV(16)+1:NADDV(17),:)

      PIEL  => ESTIMV(NADDV(18),:)
      PIAT  => ESTIMV(NADDV(18)+1:NADDV(19),:)
      PIML  => ESTIMV(NADDV(19)+1:NADDV(20),:)
      PIIO  => ESTIMV(NADDV(20)+1:NADDV(21),:)
      PIPL  => ESTIMV(NADDV(21)+1:NADDV(22),:)

      EAEL  => ESTIMV(NADDV(23),:)
      EAAT  => ESTIMV(NADDV(24),:)
      EAML  => ESTIMV(NADDV(25),:)
      EAIO  => ESTIMV(NADDV(26),:)
      EAPL  => ESTIMV(NADDV(27),:)

      EMEL  => ESTIMV(NADDV(28),:)
      EMAT  => ESTIMV(NADDV(29),:)
      EMML  => ESTIMV(NADDV(30),:)
      EMIO  => ESTIMV(NADDV(31),:)
      EMPL  => ESTIMV(NADDV(32),:)

      EIEL  => ESTIMV(NADDV(33),:)
      EIAT  => ESTIMV(NADDV(34),:)
      EIML  => ESTIMV(NADDV(35),:)
      EIIO  => ESTIMV(NADDV(36),:)
      EIPL  => ESTIMV(NADDV(37),:)

      ADDV  => ESTIMV(NADDV(NTALA)+1:NADDV(NTALA+1),:)
      COLV  => ESTIMV(NADDV(NTALC)+1:NADDV(NTALC+1),:)
      SNAPV => ESTIMV(NADDV(NTALT)+1:NADDV(NTALT+1),:)
      COPV  => ESTIMV(NADDV(NTALM)+1:NADDV(NTALM+1),:)
      BGKV  => ESTIMV(NADDV(NTALB)+1:NADDV(NTALB+1),:)
      ALGV  => ESTIMV(NADDV(NTALR)+1:NADDV(NTALR+1),:)

      PGENA => ESTIMV(NADDV(NTALV-8)+1:NADDV(NTALV-7),:)
      PGENM => ESTIMV(NADDV(NTALV-7)+1:NADDV(NTALV-6),:)
      PGENI => ESTIMV(NADDV(NTALV-6)+1:NADDV(NTALV-5),:)
      EGENA => ESTIMV(NADDV(NTALV-5)+1:NADDV(NTALV-4),:)
      EGENM => ESTIMV(NADDV(NTALV-4)+1:NADDV(NTALV-3),:)
      EGENI => ESTIMV(NADDV(NTALV-3)+1:NADDV(NTALV-2),:)
      VGENA => ESTIMV(NADDV(NTALV-2)+1:NADDV(NTALV-1),:)
      VGENM => ESTIMV(NADDV(NTALV-1)+1:NADDV(NTALV-0),:)
      VGENI => ESTIMV(NADDV(NTALV-0)+1:              ,:)

C  SURFACE AVERAGED TALLIES

      POTAT  => ESTIMS(1:NADDW(2),:)
      PRFAAT => ESTIMS(NADDW(2)+1:NADDW(3),:)
      PRFMAT => ESTIMS(NADDW(3)+1:NADDW(4),:)
      PRFIAT => ESTIMS(NADDW(4)+1:NADDW(5),:)
      PRFPAT => ESTIMS(NADDW(5)+1:NADDW(6),:)
C
      POTML  => ESTIMS(NADDW(6)+1:NADDW(7),:)
      PRFAML => ESTIMS(NADDW(7)+1:NADDW(8),:)
      PRFMML => ESTIMS(NADDW(8)+1:NADDW(9),:)
      PRFIML => ESTIMS(NADDW(9)+1:NADDW(10),:)
      PRFPML => ESTIMS(NADDW(10)+1:NADDW(11),:)
C
      POTIO  => ESTIMS(NADDW(11)+1:NADDW(12),:)
      PRFAIO => ESTIMS(NADDW(12)+1:NADDW(13),:)
      PRFMIO => ESTIMS(NADDW(13)+1:NADDW(14),:)
      PRFIIO => ESTIMS(NADDW(14)+1:NADDW(15),:)
      PRFPIO => ESTIMS(NADDW(15)+1:NADDW(16),:)
C
      POTPL  => ESTIMS(NADDW(16)+1:NADDW(17),:)
C
      EOTAT  => ESTIMS(NADDW(17)+1:NADDW(18),:)
      ERFAAT => ESTIMS(NADDW(18)+1:NADDW(19),:)
      ERFMAT => ESTIMS(NADDW(19)+1:NADDW(20),:)
      ERFIAT => ESTIMS(NADDW(20)+1:NADDW(21),:)
      ERFPAT => ESTIMS(NADDW(21)+1:NADDW(22),:)
C                  
      EOTML  => ESTIMS(NADDW(22)+1:NADDW(23),:)
      ERFAML => ESTIMS(NADDW(23)+1:NADDW(24),:)
      ERFMML => ESTIMS(NADDW(24)+1:NADDW(25),:)
      ERFIML => ESTIMS(NADDW(25)+1:NADDW(26),:)
      ERFPML => ESTIMS(NADDW(26)+1:NADDW(27),:)
C
      EOTIO  => ESTIMS(NADDW(27)+1:NADDW(28),:)
      ERFAIO => ESTIMS(NADDW(28)+1:NADDW(29),:)
      ERFMIO => ESTIMS(NADDW(29)+1:NADDW(30),:)
      ERFIIO => ESTIMS(NADDW(30)+1:NADDW(31),:)
      ERFPIO => ESTIMS(NADDW(31)+1:NADDW(32),:)
C
      EOTPL  => ESTIMS(NADDW(32)+1:NADDW(33),:)
C
      SPTAT  => ESTIMS(NADDW(33)+1:NADDW(34),:)
      SPTML  => ESTIMS(NADDW(34)+1:NADDW(35),:)
      SPTIO  => ESTIMS(NADDW(35)+1:NADDW(36),:)
      SPTPL  => ESTIMS(NADDW(36)+1:NADDW(37),:)
      SPTTOT => ESTIMS(NADDW(38),:)
      ADDS   => ESTIMS(NADDW(38)+1:NADDW(39),:)
      ALGS   => ESTIMS(NADDW(39)+1:NADDW(40),:)
      SPUMP  => ESTIMS(NADDW(40)+1:,:)

      RETURN
      END SUBROUTINE ASSOCIATE_CESTIM


      SUBROUTINE DEALLOC_CESTIM
C
      IF (.NOT.ALLOCATED(ESTIMV)) RETURN

      DEALLOCATE (ESTIMV)
      DEALLOCATE (ESTIMS)
      DEALLOCATE (NFIRST)
      DEALLOCATE (NADDV)
      DEALLOCATE (IRESC1)
      DEALLOCATE (IRESC2)
      DEALLOCATE (NFRSTW)
      DEALLOCATE (NADDW)

      RETURN
      END SUBROUTINE DEALLOC_CESTIM


      SUBROUTINE INIT_CESTIM
C
      ESTIMV = 0._DP
      ESTIMS = 0._DP
      NFIRST = 0
      NADDV  = 0
      IRESC1 = 0
      IRESC2 = 0
      NFRSTW = 0
      NADDW  = 0

      RETURN
      END SUBROUTINE INIT_CESTIM

      END MODULE CESTIM
