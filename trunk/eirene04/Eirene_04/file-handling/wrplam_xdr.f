C
C
      SUBROUTINE WRPLAM_XDR(TRCFLE,IFLG)
      USE PRECISION
      USE PARMMOD
      USE COMUSR
      USE CZT1
      USE COMSOU
      USE CSTEP
      USE COMXS
      IMPLICIT NONE
      INTEGER, INTENT(IN) :: IFLG
      LOGICAL TRCFLE
      REAL(DP), ALLOCATABLE :: RDUM(:)
      INTEGER, ALLOCATABLE :: IDUM(:)
      LOGICAL, ALLOCATABLE :: LDUM(:)
      INTEGER :: NRDUM, NIDUM, NLDUM
      INTEGER :: IUN, ISPZ
C
      CALL FXDROPN ('fort13','ENCODE',iun)
  
      CALL FXDRDBL (IUN,TEIN,NRAD)
      CALL FXDRDBL (IUN,TIIN,NPLSTI*NRAD)
      CALL FXDRDBL (IUN,DEIN,NRAD)
      CALL FXDRDBL (IUN,DIIN,NPLS*NRAD)
      CALL FXDRDBL (IUN,VXIN,NPLSV*NRAD)
      CALL FXDRDBL (IUN,VYIN,NPLSV*NRAD)
      CALL FXDRDBL (IUN,VZIN,NPLSV*NRAD)
      CALL FXDRDBL (IUN,BXIN,NRAD)
      CALL FXDRDBL (IUN,BYIN,NRAD)
      CALL FXDRDBL (IUN,BZIN,NRAD)
      CALL FXDRDBL (IUN,BFIN,NRAD)
      CALL FXDRDBL (IUN,ADIN,NAIN*NRAD)
      CALL FXDRDBL (IUN,EDRIFT,NPLS*NRAD)
      CALL FXDRDBL (IUN,VOL,NRAD)
      CALL FXDRDBL (IUN,WGHT,NSPZMC*NRAD)
      CALL FXDRDBL (IUN,BXPERP,NRAD)
      CALL FXDRDBL (IUN,BYPERP,NRAD)
      CALL FXDRDBL (IUN,FLXOUT,NLMPGS)
      CALL FXDRDBL (IUN,SAREA,NLMPGS)
      CALL FXDRDBL (IUN,TEINL,NRAD)
      CALL FXDRDBL (IUN,TIINL,NPLSTI*NRAD)
      CALL FXDRDBL (IUN,DEINL,NRAD)
      CALL FXDRDBL (IUN,DIINL,NPLS*NRAD)
      CALL FXDRDBL (IUN,BVIN,NPLSV*NRAD)
      CALL FXDRDBL (IUN,PARMOM,NPLS*NRAD)
      CALL FXDRDBL (IUN,RMASSI,NION)
      CALL FXDRDBL (IUN,RMASSA,NATM)
      CALL FXDRDBL (IUN,RMASSM,NMOL)
      CALL FXDRDBL (IUN,RMASSP,NPLS)
      CALL FXDRDBL (IUN,DIOD,NION)
      CALL FXDRDBL (IUN,DATD,NATM)
      CALL FXDRDBL (IUN,DMLD,NMOL)
      CALL FXDRDBL (IUN,DPLD,NPLS)
      CALL FXDRDBL (IUN,DPHD,NPHOT)
      CALL FXDRDBL (IUN,DION,NION)
      CALL FXDRDBL (IUN,DATM,NATM)
      CALL FXDRDBL (IUN,DMOL,NMOL)
      CALL FXDRDBL (IUN,DPLS,NPLS)
      CALL FXDRDBL (IUN,DPHOT,NPHOT)
      CALL FXDRDBL (IUN,TVAC,1)
      CALL FXDRDBL (IUN,DVAC,1)
      CALL FXDRDBL (IUN,VVAC,1)
      CALL FXDRDBL (IUN,ALLOC,1)

      DO ISPZ=1,NSPZ
        CALL FXDRCHR (IUN,TEXTS(ISPZ))
      END DO

      CALL FXDRINT (IUN,NSPH,1)
      CALL FXDRINT (IUN,NPHOTI,1)
      CALL FXDRINT (IUN,NPHOTIM,1)
      CALL FXDRINT (IUN,NFOLPH,NPHOT)
      CALL FXDRINT (IUN,NGENPH,NPHOT)
      CALL FXDRINT (IUN,NSPA,1)
      CALL FXDRINT (IUN,NATMI,1)
      CALL FXDRINT (IUN,NATMIM,1)
      CALL FXDRINT (IUN,NMASSA,NATM)
      CALL FXDRINT (IUN,NCHARA,NATM)
      CALL FXDRINT (IUN,NFOLA,NATM)
      CALL FXDRINT (IUN,NGENA,NATM)
      CALL FXDRINT (IUN,NSPAM,1)
      CALL FXDRINT (IUN,NMOLI,1)
      CALL FXDRINT (IUN,NMOLIM,1)
      CALL FXDRINT (IUN,NMASSM,NMOL)
      CALL FXDRINT (IUN,NCHARM,NMOL)
      CALL FXDRINT (IUN,NFOLM,NMOL)
      CALL FXDRINT (IUN,NGENM,NMOL)
      CALL FXDRINT (IUN,NSPAMI,1)
      CALL FXDRINT (IUN,NIONI,1)
      CALL FXDRINT (IUN,NIONIM,1)
      CALL FXDRINT (IUN,NMASSI,NION)
      CALL FXDRINT (IUN,NCHARI,NION)
      CALL FXDRINT (IUN,NCHRGI,NION)
      CALL FXDRINT (IUN,NFOLI,NION)
      CALL FXDRINT (IUN,NGENI,NION)
      CALL FXDRINT (IUN,NSPTOT,1)
      CALL FXDRINT (IUN,NPLSI,1)
      CALL FXDRINT (IUN,NPLSIM,1)
      CALL FXDRINT (IUN,NMASSP,NPLS)
      CALL FXDRINT (IUN,NCHARP,NPLS)
      CALL FXDRINT (IUN,NCHRGP,NPLS)
      CALL FXDRINT (IUN,NBITS,1)
      CALL FXDRINT (IUN,NSNVI,1)
      CALL FXDRINT (IUN,NCPVI,1)
      CALL FXDRINT (IUN,NADVI,1)
      CALL FXDRINT (IUN,NBGVI,1)
      CALL FXDRINT (IUN,NALVI,1)
      CALL FXDRINT (IUN,NCLVI,1)
      CALL FXDRINT (IUN,NADSI,1)
      CALL FXDRINT (IUN,NALSI,1)
      CALL FXDRINT (IUN,NAINI,1)
      CALL FXDRINT (IUN,NPRT,NSPZ)
      CALL FXDRINT (IUN,ISPEZ,6*(NPHOT+2)*(NATM+2)*(NMOL+2)*(NION+2)*
     .              (NPLS+2))
      CALL FXDRINT (IUN,ISPEZI,6*NSPZ)
      CALL FXDRINT (IUN,MPLSTI,NPLS)
      CALL FXDRINT (IUN,MPLSV,NPLS)

      CALL FXDRLOG (IUN,LGVAC,(NPLS+2)*NRAD)
      CALL FXDRLOG (IUN,LGDFT,NRAD)

      IF (TRCFLE) WRITE (6,*) 'WRITE 13: RCMUSR,ICMUSR,LCMUSR '

      CALL CMDTA_XDR (IUN)
      IF (TRCFLE) WRITE (6,*) 'WRITE 13: RCMDTA,ICMDTA'

      CALL CMAMF_XDR (IUN)
      IF (TRCFLE) WRITE (6,*) 'WRITE 13: RCMAMF,ICMAMF'

      CALL FXDRDBL (IUN,RCZT1,NZT1)
      CALL FXDRDBL (IUN,RCZT2,NZT2)
      CALL FXDRDBL (IUN,ZT1,NPLS*NRAD)
      CALL FXDRDBL (IUN,ZRG,NPLS*NRAD)
      IF (TRCFLE) WRITE (6,*) 'WRITE 13: RCZT1,RCZT2,ZT1,ZRG'

      CALL FXDRDBL (IUN,RCMSOU,(12+11*NSRFS)*NSTRA)
      CALL FXDRDBL (IUN,SREC,(NPLS+1)*(NREC+1))
      CALL FXDRDBL (IUN,EIO,(NPLS+1)*(NREC+1))
      CALL FXDRDBL (IUN,EEL,(NPLS+1)*(NREC+1))
      CALL FXDRINT (IUN,ICMSOU,(14+9*NSRFS)*NSTRA)
      CALL FXDRINT (IUN,INGRDA,NSRFS*NSTRA*3)
      CALL FXDRINT (IUN,INGRDE,NSRFS*NSTRA*3)
      CALL FXDRINT (IUN,NSTRAI,1)
      CALL FXDRLOG (IUN,LCMSOU,13*NSTRA)
      CALL FXDRLOG (IUN,NLSYMP,NSTRA+1)
      CALL FXDRLOG (IUN,NLSYMT,NSTRA+1)
      IF (TRCFLE) WRITE (6,*) 'WRITE 13: RCMSOU,ICMSOU,LCMSOU'

      IF (ALLOCATED(FLSTEP)) THEN
        CALL FXDRDBL (IUN,FLSTEP,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,ELSTEP,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,FLTOT,(NSPZ+1)*NSTEP)
        CALL FXDRDBL (IUN,VF,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,QUOT,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,ADD,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,QUOTI,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,ADDIV,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,TESTEP,NSTEP*NGITT)
        CALL FXDRDBL (IUN,TISTEP,NPLSTI*NSTEP*NGITT)
        CALL FXDRDBL (IUN,RRSTEP,NSTEP*NGITT)
        CALL FXDRDBL (IUN,VXSTEP,NPLSV*NSTEP*NGITT)
        CALL FXDRDBL (IUN,VYSTEP,NPLSV*NSTEP*NGITT)
        CALL FXDRDBL (IUN,VZSTEP,NPLSV*NSTEP*NGITT)
        CALL FXDRDBL (IUN,DISTEP,NPLS*NSTEP*NGITT)
        CALL FXDRINT (IUN,IRSTEP,NSTEP*NGITT)
        CALL FXDRINT (IUN,IPSTEP,NSTEP*NGITT)
        CALL FXDRINT (IUN,ITSTEP,NSTEP*NGITT)
        CALL FXDRINT (IUN,IASTEP,NSTEP*NGITT)
        CALL FXDRINT (IUN,IBSTEP,NSTEP*NGITT)
        CALL FXDRINT (IUN,IGSTEP,NSTEP*NGITT)
        CALL FXDRINT (IUN,ISTUF,NSTEP)
        CALL FXDRINT (IUN,NSMAX,NSTEP)
        CALL FXDRINT (IUN,NSPSTI,NSTEP)
        CALL FXDRINT (IUN,NSPSTE,NSTEP)
        IF (TRCFLE) WRITE (6,*) 'WRITE 13: RCSTEP,ICSTEP'
      END IF

      CALL FXDRCLS (IUN)	
      RETURN
C
C
C
      ENTRY RPLAM_XDR(TRCFLE,IFLG)
C
      CALL FXDROPN ('fort13','DECODE',iun)
  
      CALL FXDRDBL (IUN,TEIN,NRAD)
      CALL FXDRDBL (IUN,TIIN,NPLSTI*NRAD)
      CALL FXDRDBL (IUN,DEIN,NRAD)
      CALL FXDRDBL (IUN,DIIN,NPLS*NRAD)
      CALL FXDRDBL (IUN,VXIN,NPLSTI*NRAD)
      CALL FXDRDBL (IUN,VYIN,NPLSTI*NRAD)
      CALL FXDRDBL (IUN,VZIN,NPLSTI*NRAD)
      CALL FXDRDBL (IUN,BXIN,NRAD)
      CALL FXDRDBL (IUN,BYIN,NRAD)
      CALL FXDRDBL (IUN,BZIN,NRAD)
      CALL FXDRDBL (IUN,BFIN,NRAD)
      CALL FXDRDBL (IUN,ADIN,NAIN*NRAD)
      CALL FXDRDBL (IUN,EDRIFT,NPLS*NRAD)
      CALL FXDRDBL (IUN,VOL,NRAD)
      CALL FXDRDBL (IUN,WGHT,NSPZMC*NRAD)
      CALL FXDRDBL (IUN,BXPERP,NRAD)
      CALL FXDRDBL (IUN,BYPERP,NRAD)
      CALL FXDRDBL (IUN,FLXOUT,NLMPGS)
      CALL FXDRDBL (IUN,SAREA,NLMPGS)
      CALL FXDRDBL (IUN,TEINL,NRAD)
      CALL FXDRDBL (IUN,TIINL,NPLSTI*NRAD)
      CALL FXDRDBL (IUN,DEINL,NRAD)
      CALL FXDRDBL (IUN,DIINL,NPLS*NRAD)
      CALL FXDRDBL (IUN,BVIN,NPLSV*NRAD)
      CALL FXDRDBL (IUN,PARMOM,NPLS*NRAD)
      CALL FXDRDBL (IUN,RMASSI,NION)
      CALL FXDRDBL (IUN,RMASSA,NATM)
      CALL FXDRDBL (IUN,RMASSM,NMOL)
      CALL FXDRDBL (IUN,RMASSP,NPLS)
      CALL FXDRDBL (IUN,DIOD,NION)
      CALL FXDRDBL (IUN,DATD,NATM)
      CALL FXDRDBL (IUN,DMLD,NMOL)
      CALL FXDRDBL (IUN,DPLD,NPLS)
      CALL FXDRDBL (IUN,DPHD,NPHOT)
      CALL FXDRDBL (IUN,DION,NION)
      CALL FXDRDBL (IUN,DATM,NATM)
      CALL FXDRDBL (IUN,DMOL,NMOL)
      CALL FXDRDBL (IUN,DPLS,NPLS)
      CALL FXDRDBL (IUN,DPHOT,NPHOT)
      CALL FXDRDBL (IUN,TVAC,1)
      CALL FXDRDBL (IUN,DVAC,1)
      CALL FXDRDBL (IUN,VVAC,1)
      CALL FXDRDBL (IUN,ALLOC,1)

      DO ISPZ=1,NSPZ
        CALL FXDRCHR (IUN,TEXTS(ISPZ))
      END DO

      CALL FXDRINT (IUN,NSPH,1)
      CALL FXDRINT (IUN,NPHOTI,1)
      CALL FXDRINT (IUN,NPHOTIM,1)
      CALL FXDRINT (IUN,NFOLPH,NPHOT)
      CALL FXDRINT (IUN,NGENPH,NPHOT)
      CALL FXDRINT (IUN,NSPA,1)
      CALL FXDRINT (IUN,NATMI,1)
      CALL FXDRINT (IUN,NATMIM,1)
      CALL FXDRINT (IUN,NMASSA,NATM)
      CALL FXDRINT (IUN,NCHARA,NATM)
      CALL FXDRINT (IUN,NFOLA,NATM)
      CALL FXDRINT (IUN,NGENA,NATM)
      CALL FXDRINT (IUN,NSPAM,1)
      CALL FXDRINT (IUN,NMOLI,1)
      CALL FXDRINT (IUN,NMOLIM,1)
      CALL FXDRINT (IUN,NMASSM,NMOL)
      CALL FXDRINT (IUN,NCHARM,NMOL)
      CALL FXDRINT (IUN,NFOLM,NMOL)
      CALL FXDRINT (IUN,NGENM,NMOL)
      CALL FXDRINT (IUN,NSPAMI,1)
      CALL FXDRINT (IUN,NIONI,1)
      CALL FXDRINT (IUN,NIONIM,1)
      CALL FXDRINT (IUN,NMASSI,NION)
      CALL FXDRINT (IUN,NCHARI,NION)
      CALL FXDRINT (IUN,NCHRGI,NION)
      CALL FXDRINT (IUN,NFOLI,NION)
      CALL FXDRINT (IUN,NGENI,NION)
      CALL FXDRINT (IUN,NSPTOT,1)
      CALL FXDRINT (IUN,NPLSI,1)
      CALL FXDRINT (IUN,NPLSIM,1)
      CALL FXDRINT (IUN,NMASSP,NPLS)
      CALL FXDRINT (IUN,NCHARP,NPLS)
      CALL FXDRINT (IUN,NCHRGP,NPLS)
      CALL FXDRINT (IUN,NBITS,1)
      CALL FXDRINT (IUN,NSNVI,1)
      CALL FXDRINT (IUN,NCPVI,1)
      CALL FXDRINT (IUN,NADVI,1)
      CALL FXDRINT (IUN,NBGVI,1)
      CALL FXDRINT (IUN,NALVI,1)
      CALL FXDRINT (IUN,NCLVI,1)
      CALL FXDRINT (IUN,NADSI,1)
      CALL FXDRINT (IUN,NALSI,1)
      CALL FXDRINT (IUN,NAINI,1)
      CALL FXDRINT (IUN,NPRT,NSPZ)
      CALL FXDRINT (IUN,ISPEZ,6*(NPHOT+2)*(NATM+2)*(NMOL+2)*(NION+2)*
     .              (NPLS+2))
      CALL FXDRINT (IUN,ISPEZI,6*NSPZ)
      CALL FXDRINT (IUN,MPLSTI,NPLS)
      CALL FXDRINT (IUN,MPLSV,NPLS)

      CALL FXDRLOG (IUN,LGVAC,(NPLS+2)*NRAD)
      CALL FXDRLOG (IUN,LGDFT,NRAD)

      IF (TRCFLE) WRITE (6,*) 'WRITE 13: RCMUSR,ICMUSR,LCMUSR '

      CALL CMDTA_XDR (IUN)
      IF (TRCFLE) WRITE (6,*) 'WRITE 13: RCMDTA,ICMDTA'

      CALL CMAMF_XDR (IUN)
      IF (TRCFLE) WRITE (6,*) 'WRITE 13: RCMAMF,ICMAMF'

      CALL FXDRDBL (IUN,RCZT1,NZT1)
      CALL FXDRDBL (IUN,RCZT2,NZT2)
      CALL FXDRDBL (IUN,ZT1,NPLS*NRAD)
      CALL FXDRDBL (IUN,ZRG,NPLS*NRAD)
      IF (TRCFLE) WRITE (6,*) 'WRITE 13: RCZT1,RCZT2,ZT1,ZRG'

      IF (IFLG == 0) THEN
        CALL FXDRDBL (IUN,RCMSOU,(12+11*NSRFS)*NSTRA)
        CALL FXDRDBL (IUN,SREC,(NPLS+1)*(NREC+1))
        CALL FXDRDBL (IUN,EIO,(NPLS+1)*(NREC+1))
        CALL FXDRDBL (IUN,EEL,(NPLS+1)*(NREC+1))
        CALL FXDRINT (IUN,ICMSOU,(14+9*NSRFS)*NSTRA)
        CALL FXDRINT (IUN,INGRDA,NSRFS*NSTRA*3)
        CALL FXDRINT (IUN,INGRDE,NSRFS*NSTRA*3)
        CALL FXDRINT (IUN,NSTRAI,1)
        CALL FXDRLOG (IUN,LCMSOU,13*NSTRA)
        CALL FXDRLOG (IUN,NLSYMP,NSTRA+1)
        CALL FXDRLOG (IUN,NLSYMT,NSTRA+1)
        IF (TRCFLE) WRITE (6,*) 'WRITE 13: RCMSOU,ICMSOU,LCMSOU'
      ELSE
        NRDUM = MAX(SIZE(RCMSOU), SIZE(SREC), SIZE(EIO), SIZE(EEL))  
        NIDUM = MAX(SIZE(ICMSOU), SIZE(INGRDA), SIZE(INGRDE))
        NLDUM = MAX(SIZE(LCMSOU), SIZE(NLSYMP), SIZE(NLSYMT))
        ALLOCATE (RDUM(NRDUM))
        ALLOCATE (IDUM(NIDUM))
        ALLOCATE (LDUM(NLDUM))
        CALL FXDRDBL (IUN,RDUM,SIZE(RCMSOU))
        CALL FXDRDBL (IUN,RDUM,SIZE(SREC))
        CALL FXDRDBL (IUN,RDUM,SIZE(EIO))
        CALL FXDRDBL (IUN,RDUM,SIZE(EEL))
        CALL FXDRINT (IUN,IDUM,SIZE(LCMSOU))
        CALL FXDRINT (IUN,IDUM,SIZE(INGRDA))
        CALL FXDRINT (IUN,IDUM,SIZE(INGRDE))
        CALL FXDRINT (IUN,IDUM,1)
        CALL FXDRLOG (IUN,LDUM,SIZE(LCMSOU))
        CALL FXDRLOG (IUN,LDUM,SIZE(NLSYMP))
        CALL FXDRLOG (IUN,LDUM,SIZE(NLSYMT))
        DEALLOCATE (RDUM)
        DEALLOCATE (IDUM)
        DEALLOCATE (LDUM)
      END IF

      IF (ALLOCATED(FLSTEP)) THEN
        CALL FXDRDBL (IUN,FLSTEP,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,ELSTEP,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,FLTOT,(NSPZ+1)*NSTEP)
        CALL FXDRDBL (IUN,VF,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,QUOT,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,ADD,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,QUOTI,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,ADDIV,(NSPZ+1)*NSTEP*NGITT)
        CALL FXDRDBL (IUN,TESTEP,NSTEP*NGITT)
        CALL FXDRDBL (IUN,TISTEP,NPLSTI*NSTEP*NGITT)
        CALL FXDRDBL (IUN,RRSTEP,NSTEP*NGITT)
        CALL FXDRDBL (IUN,VXSTEP,NPLSV*NSTEP*NGITT)
        CALL FXDRDBL (IUN,VYSTEP,NPLSV*NSTEP*NGITT)
        CALL FXDRDBL (IUN,VZSTEP,NPLSV*NSTEP*NGITT)
        CALL FXDRDBL (IUN,DISTEP,NPLS*NSTEP*NGITT)
        CALL FXDRINT (IUN,IRSTEP,NSTEP*NGITT)
        CALL FXDRINT (IUN,IPSTEP,NSTEP*NGITT)
        CALL FXDRINT (IUN,ITSTEP,NSTEP*NGITT)
        CALL FXDRINT (IUN,IASTEP,NSTEP*NGITT)
        CALL FXDRINT (IUN,IBSTEP,NSTEP*NGITT)
        CALL FXDRINT (IUN,IGSTEP,NSTEP*NGITT)
        CALL FXDRINT (IUN,ISTUF,NSTEP)
        CALL FXDRINT (IUN,NSMAX,NSTEP)
        CALL FXDRINT (IUN,NSPSTI,NSTEP)
        CALL FXDRINT (IUN,NSPSTE,NSTEP)
        IF (TRCFLE) WRITE (6,*) 'WRITE 13: RCSTEP,ICSTEP'
      END IF

      CALL FXDRCLS (IUN)	
      RETURN
      END
