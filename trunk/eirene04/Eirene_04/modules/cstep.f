      MODULE CSTEP

      USE PRECISION
      USE PARMMOD

      IMPLICIT NONE

      PRIVATE

      PUBLIC :: ALLOC_CSTEP, DEALLOC_CSTEP, INIT_CSTEP

      REAL(DP), PUBLIC, ALLOCATABLE, SAVE ::
     R FLSTEP(:,:,:), ELSTEP(:,:,:), FLTOT(:,:),
     R VF(:,:,:),     QUOT(:,:,:),   ADD(:,:,:),
     R QUOTI(:,:,:),  ADDIV(:,:,:),
     R TESTEP(:,:),   TISTEP(:,:,:), RRSTEP(:,:),  
     R VXSTEP(:,:,:), VYSTEP(:,:,:), VZSTEP(:,:,:),
     R DISTEP(:,:,:)

      INTEGER, PUBLIC, ALLOCATABLE, SAVE ::
     I IRSTEP(:,:), IPSTEP(:,:), ITSTEP(:,:),
     I IASTEP(:,:), IBSTEP(:,:), IGSTEP(:,:),
     I ISTUF(:),
     I NSMAX(:),    NSPSTI(:),   NSPSTE(:)

      INTEGER, PUBLIC, SAVE ::
     .   NSTPP1, NSTPP2, NSTPP3

      CONTAINS


      SUBROUTINE ALLOC_CSTEP

      IF (ALLOCATED(FLSTEP)) RETURN

      NSTPP1=(NSPZ+1)*NSTEP*NGITT
      NSTPP2=NSTEP*NGITT
      NSTPP3=NPLS*NSTEP*NGITT

      ALLOCATE (FLSTEP(0:NSPZ,NSTEP,NGITT))
      ALLOCATE (ELSTEP(0:NSPZ,NSTEP,NGITT))
      ALLOCATE (FLTOT(0:NSPZ,NSTEP))
      ALLOCATE (VF(0:NSPZ,NSTEP,NGITT))
      ALLOCATE (QUOT(0:NSPZ,NSTEP,NGITT))
      ALLOCATE (ADD(0:NSPZ,NSTEP,NGITT))
      ALLOCATE (QUOTI(0:NSPZ,NSTEP,NGITT))
      ALLOCATE (ADDIV(0:NSPZ,NSTEP,NGITT))
      ALLOCATE (TESTEP(NSTEP,NGITT))
      ALLOCATE (TISTEP(NPLSTI,NSTEP,NGITT))
      ALLOCATE (RRSTEP(NSTEP,NGITT))
      ALLOCATE (VXSTEP(NPLSV,NSTEP,NGITT))
      ALLOCATE (VYSTEP(NPLSV,NSTEP,NGITT))
      ALLOCATE (VZSTEP(NPLSV,NSTEP,NGITT))
      ALLOCATE (DISTEP(NPLS,NSTEP,NGITT))

      ALLOCATE (IRSTEP(NSTEP,NGITT))
      ALLOCATE (IPSTEP(NSTEP,NGITT))
      ALLOCATE (ITSTEP(NSTEP,NGITT))
      ALLOCATE (IASTEP(NSTEP,NGITT))
      ALLOCATE (IBSTEP(NSTEP,NGITT))
      ALLOCATE (IGSTEP(NSTEP,NGITT))
      ALLOCATE (ISTUF(NSTEP))
      ALLOCATE (NSMAX(NSTEP))
      ALLOCATE (NSPSTI(NSTEP))
      ALLOCATE (NSPSTE(NSTEP))

      WRITE (55,'(A,T25,I15)')
     .       ' CSTEP ',(7*NSTPP1+(NSPZ+1)*NSTEP+2*NSTPP2+1*NSTPP3 +
     .                  (NPLSTI+3*NPLSV)*NSTPP2)*8 + 
     .                 (6*NSTPP2+4*NSTEP)*4

      CALL INIT_CSTEP

      RETURN
      END SUBROUTINE ALLOC_CSTEP


      SUBROUTINE DEALLOC_CSTEP

      IF (.NOT.ALLOCATED(FLSTEP)) RETURN

      DEALLOCATE (FLSTEP)
      DEALLOCATE (ELSTEP)
      DEALLOCATE (FLTOT)
      DEALLOCATE (VF)
      DEALLOCATE (QUOT)
      DEALLOCATE (ADD)
      DEALLOCATE (QUOTI)
      DEALLOCATE (ADDIV)
      DEALLOCATE (TESTEP)
      DEALLOCATE (TISTEP)
      DEALLOCATE (RRSTEP)
      DEALLOCATE (VXSTEP)
      DEALLOCATE (VYSTEP)
      DEALLOCATE (VZSTEP)
      DEALLOCATE (DISTEP)

      DEALLOCATE (IRSTEP)
      DEALLOCATE (IPSTEP)
      DEALLOCATE (ITSTEP)
      DEALLOCATE (IASTEP)
      DEALLOCATE (IBSTEP)
      DEALLOCATE (IGSTEP)
      DEALLOCATE (ISTUF)
      DEALLOCATE (NSMAX)
      DEALLOCATE (NSPSTI)
      DEALLOCATE (NSPSTE)

      RETURN
      END SUBROUTINE DEALLOC_CSTEP


      SUBROUTINE INIT_CSTEP

      FLSTEP = 0._DP
      ELSTEP = 0._DP
      FLTOT  = 0._DP
      VF     = 0._DP
      QUOT   = 0._DP
      ADD    = 0._DP
      QUOTI  = 0._DP
      ADDIV  = 0._DP
      TESTEP = 0._DP
      TISTEP = 0._DP
      RRSTEP = 0._DP
      VXSTEP = 0._DP
      VYSTEP = 0._DP
      VZSTEP = 0._DP
      DISTEP = 0._DP

      IRSTEP = 0
      IPSTEP = 0
      ITSTEP = 0
      IASTEP = 0
      IBSTEP = 0
      IGSTEP = 0
      ISTUF  = 0
      NSMAX  = 0
      NSPSTI = 0
      NSPSTE = 0

      RETURN
      END SUBROUTINE INIT_CSTEP

      END MODULE CSTEP
