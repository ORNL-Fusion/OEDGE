C  nov.05:  cleanup: ispz=nspa+imol, instead ispz=nsph+natmi+imol
C  jan.06:  user reflection model: modref=3 --> modref=9
C  feb06:   check for valid MODREF added
C  apr06:   spelling error corrected: rprop --> rprob (2 times)
C  aug06:   printout of reflection properties of surfaces only for 
C           nontransparent surfaces
C
      SUBROUTINE REFLEC
C
C  REFLECT ESCAPING ATOMS OR IONS
C  INPUT:
C       ILREF = 1  DATABASE REFLECTION MODEL, W.ECKSTEIN, D.B.HEIFETZ,
C                  IPP 9/59 (1986)
C       ILREF = 2  MODIFIED BEHRISCH MATRIX, R. BEHRISCH, ERICE SUMMER
C                  SCHOOL 1976
C       ILREF = 9  USER SUPPLIED REFLECTION MODEL, CALL: RF1USR
C
C       ITYP  = 1  INCIDENT ATOM
C       ITYP  = 3  INCIDENT TEST ION
C       ITYP  = 4  INCIDENT BULK ION
C  OUTPUT:
C     LGPART= TRUE AND:
C       ITYP = 1  ATOM IATM IS RETURNED TO CALLING PROGRAM
C       ITYP = 2  MOLECULE IMOL IS RETURNED TO CALLING PROGRAM
C       ITYP = 3  TEST ION  IION IS RETURNED TO CALLING PROGRAM
C     LGPART= FALSE  NO PARTICLE IS RETURNED (ABSORBTION)
C       ITYP = -1
C
      USE PRECISION
      USE PARMMOD
      USE COMUSR
      USE CREFMOD
      USE CESTIM
      USE CADGEO
      USE CCONA
      USE CLOGAU
      USE CRAND
      USE CREF
      USE CZT1
      USE CTRCEI
      USE COMPRT
      USE CLGIN
      USE CSPEI
      USE CPES

      IMPLICIT NONE
C
C---------------------------------------------------------------------
C
      REAL(DP) ::
     .  ZRANGE(0:12),ZDE(12),ZDEL(12),ZENGY(0:12),ZR(0:12),ZIDE(12,12),
     .  ZIDED(12,12),XSP(12),YSP(12),ASP(12),BSP(12),CSP(12),DSP(12),
     .  E0AV(0:12),QUOTR(0:11),QUOTE(0:11)
      REAL(DP) :: EREDC, VX, VY, VZ, ED, ZCTHET, ZSTHET, RO4, ZCPHI,
     .          ZSPHI, RO5, PRBRF, FTHOMP, WATOM, RPROBA, ZE0, ZA, A,
     .          ZTHET, ZE, ESUM, EFAC, ZDELTA, COSI2, WABS, WLOSS, TW,
     .          FLPRT, WMOLEC, RPROBM, FR2, PRTEST, RPROBL, DUMMY,
     .          XCH, XMFE, XMH, EPSHFE, E0TERM, XCW, EBIND, PRFCT,
     .          PRFCF, XMW, CON, ZWDR, EOQ, XMP, WMIN,
     .          XCP, XCFE, DX, EXPP, RO1, EQSAVE, ZEP1, RO3,
     .          EMINR, EMAXR, RPROB, COSIN, EXPI, EXPE, RINTG, AINTG,
     .          EINTG, EFCT, EQTO, ETEST, EQT, F1, WFAC, F2, EREDUC,
     .          FR1, XMTT, XCTT, XMPP, XCPP, RO2
      REAL(DP) :: RF, RF1, RF2, RF3, RF4, RF5, RF6, RF7, RF8, RF9, RF10,
     .          RF11, RF12, RF13, RF14, RF15, RF16,
     .          RFF1, RFF2, RFF3, RFF4, RFF5, RFF6, RFF7, RFF8,
     .          RFFF1, RFFF2, RFFF3, RFFF4,
     .          RFFFF1, RFFFF2
      REAL(DP), EXTERNAL :: RANF_EIRENE, RANSET_EIRENE
      INTEGER :: NPANOLD, IDIM, IRANGE, IRM, INDR2, INDR3P, MSS,
     .           IBOX, ILIM, JP, ISP, ISTS, I, ISEE, MODREF, IGAST,
     .           IGASF, NPRIN, LEARCA, NRE, NREP, ICOUNT, IFIRST, J,
     .           NRI, INDR3, ISAVE, INDEP, INDWP, INDE, INDR2P, INDR1P,
     .           INDR1, ISPZO, IFILE, INDW
      INTEGER, EXTERNAL :: RANGET_EIRENE
      LOGICAL :: NLDATA, NLBEHR

      SAVE
C  SIZE OF "BEHRISCH TABLES"
      DATA IDIM/12/
C  ENERGY , ABSZISSA FOR REFLECTION PROBABILITY, H INCIDENT ON FE
      DATA
     .   ZENGY/0.,4.64,10.0,21.5,46.4,100.0,215.4,464.1,1000.0,2154.3,
     .         4641.3,10000.0,21543.0/
C  REFLECTION PROBABILITY RPROB(ENERGY)= ZR(ZENGY)
      DATA
     .   ZR/1.,0.9,0.8,0.7,0.62,0.543,0.46,0.37,0.29,0.21,0.14,
     .      0.095,0.04/
C  ENERGY RANGE FOR ENERGY DISTRIBUTION, LAST CELL IS: ZENGY
C  I.E. ABSZISSA FOR ENERGY-DISTRIBUTION-FUNCTIONS, H INCIDENT ON FE
      DATA
     .   ZRANGE/0.,6.81,14.7,31.63,68.1,146.8,316.3,681.9,1468.0,
     .          3162.0,6813.0,14678.0,31630./
C  DISTRIBUTION FUNCTIONS ZIDE(ZRANGE) , ONE FOR EACH ZENGY
      DATA ZIDE
     . /12*1.,
     .  0.2,11*1.,
     .  0.1,0.2,10*1.,
     .  0.025,0.05,0.35,9*1.,
     .  0.012,0.025,0.1,0.45,8*1.,
     .  0.01,0.02,0.05,0.15,0.55,7*1.,
     .  0.002,0.005,0.02,0.055,0.175,0.625,6*1.,
     .  0.001,0.003,0.011,0.029,0.079,0.224,0.699,5*1.,
     .  0.001,0.003,0.007,0.016,0.04,0.105,0.301,0.771,4*1.,
     .  0.,0.001,0.003,0.007,0.018,0.050,0.14,0.40,0.83,3*1.,
     .  0.,0.001,0.003,0.006,0.011,0.025,0.073,0.215,0.505,0.865,2*1.,
     .  0.,0.001,0.003,0.005,0.009,0.015,0.035,0.105,0.305,0.6,0.9,1./
C---------------------------------------------------------------------
      DATA CON/0.4685/,EOQ/14.39/,ZWDR/0.666667/,IFIRST/0/,ICOUNT/0/
      DATA NPANOLD/0/
      EREDC(XMTT,XCTT,XMPP,XCPP)=CON/EOQ*XMTT/((XMPP+XMTT)*XCPP*XCTT*
     .                       SQRT(XCPP**ZWDR+XCTT**ZWDR))
C
C  INITIALIZE SURFACE REFLECTION MODELS
C
      ENTRY REFLC0
C
      IF (IFIRST.EQ.1) RETURN
      IFIRST=1
C
      NLDATA=.FALSE.
      NLBEHR=.FALSE.
      DO 1 J=1,NLIMPS
        NLDATA=NLDATA.OR.(ILREF(J).EQ.1)
        NLBEHR=NLBEHR.OR.(ILREF(J).EQ.2)
1     CONTINUE
C
C
C  SET ADDITIONAL DATA FOR "DATABASE REFLECTION MODEL"
C
      IF (NLDATA) THEN
C
        if (my_pe .eq. 0) then
          IF (NLTRIM) THEN
            IF (LTRMOL) THEN
              CALL REFDAT(TM,TC,WM,WC)
            ELSE
              CALL RDTRIM
            ENDIF
          ELSE
            WRITE (iunout,*) 'INPUT ERROR FOR LOCAL REFLECTION MODEL'
            WRITE (iunout,*) 'DATABASE REFLECTION MODEL REQUIRED BUT '
            WRITE (iunout,*) 'NLTRIM IS NOT SET TRUE'
            CALL EXIT_OWN(1)
          ENDIF
        endif

        if (nprs > 1) call broadref
C
C  SET FACTORS FOR REDUCED ENERGY SCALING FOR ALL TARGET/PROJECTILE
C  COMBINATIONS AVAILABLE IN DATABASE MODEL
        DO 3 J=1,NFLR
          ERDC(J)=EREDC(WM(J),WC(J),TM(J),TC(J))
3       CONTINUE
C  SET UNIFORM DISTRIBUTION OF AZIMUTAL ANGLE FOR DATABASE MODEL
C  FOR PERPENDICULAR INCIDENCE (INDW=1)
        DO 4 INDR3=1,INR
          HFTR3F(INDR3)=COS(PIA*(1.-RAAR(INDR3)))
4       CONTINUE
C
        IF (TRCREF) THEN
          DO 5 J=1,NFLR
            CALL LEER(1)
            WRITE (iunout,*) 'DATABASE REFLECTION MODEL DEFINED FOR:'
            WRITE (iunout,*) 'IFILE =                      ',J
            WRITE (iunout,*) 'TARGET MASS NUMBER =         ',WM(J)
            WRITE (iunout,*) 'TARGET NUCL. CHARGE NUMBER = ',WC(J)
            WRITE (iunout,*) 'PROJECTIL MASS NUMBER =      ',TM(J)
            WRITE (iunout,*) 'PRJTL. NUCL. CHARGE NUMBER = ',TC(J)
            WRITE (iunout,*) 'REDUCED ENERGY FACTOR ERDC = ',ERDC(J)
5         CONTINUE
          CALL LEER(2)
        ENDIF
      ELSE
        INE=1
        INW=1
        INR=1
        NFLR=1
        if (nprs > 1) call broadref
      ENDIF
C
C  SET ADDITIONAL DATA FOR "BEHRISCH MATRIX REFLECTION MODEL"
C
      IF (NLBEHR) THEN
C
C  "BEHRISCH MODEL" REFLECTION PROBABILITY ZR(ZENGY)
C        FOR ENERGIES BELOW ERCUT CAN BE MODIFIED;
C        RPROB0 IS THE NEW (HYPOTHETICAL) REFL. PROB AT ZENGY(0)=0. (EV)
C        (THERE IS NO REFLECTION MODEL BUT ONLY A THERMAL PARTICLE
C        MODEL CALLED FOR E0 BELOW ERMIN)
C
C  NO MODIFICATION FOR ERCUT.LT.0.
C  ZR(0) -- ZR(NRE) ARE MODIFIED FOR ERCUT.GE.ZENGY(0)
        IF (ERCUT.GT.ZENGY(0).AND.ERCUT.LT.ZENGY(1)) THEN
          ZR(0)=RPROB0
        ELSEIF (ERCUT.GE.ZENGY(1)) THEN
          NRI=2
          NRE=LEARCA(ERCUT,ZENGY,1,13,1,'REFLEC (1)  ')-1
          NREP=NRE+1
          DX=ERCUT-ZENGY(NRE)
          XSP(1)=ZENGY(0)
          YSP(1)=RPROB0
          XSP(2)=ERCUT
          YSP(2)=(ZR(NREP)-ZR(NRE))/(ZENGY(NREP)-ZENGY(NRE))*DX+ZR(NRE)
C  SET SPLINE DATA FOR NEW REFLECTION PROBABLITY ZR(ZENGY)
          DO 6 J=NREP,12
            NRI=NRI+1
            XSP(NRI)=ZENGY(J)
            YSP(NRI)=ZR(J)
6         CONTINUE
          CALL SPLINE(XSP,YSP,NRI,ASP,BSP,CSP,DSP)
C   SET THE NEW ZR ON GRID ZENGY(J) FROM ZENGY(0) TO ZENGY(NRE)
          ZR(0)=RPROB0
          DO 7 J=0,NRE
            DX=ZENGY(J)-XSP(1)
            ZR(J)=((DSP(1)*DX+CSP(1))*DX+BSP(1))*DX+ASP(1)
7         CONTINUE
        ENDIF
C
C
C  THE BEHRISCH-REFLECTION DATA ARE GIVEN FOR H INCIDENT ON FE
C  CONVERT TO REDUCED ENERGY
C
C  CHARGE NUMBERS: STAINLESS STEEL
        XCFE=26.
C  MASS NUMBERS  : STAINLESS STEEL
        XMFE=56.
C  CHARGE NUMBER: HYDROGEN
        XCH=1.
C  MASS NUMBER  : HYDROGEN
        XMH=1.
C
        EPSHFE=EREDC(XMFE,XCFE,XMH,XCH)
C
        DO 12 J=1,12
          ZRANGE(J)=ZRANGE(J)*EPSHFE
          ZDE(J)=ZRANGE(J)-ZRANGE(J-1)
          ZENGY(J)=ZENGY(J)*EPSHFE
12      CONTINUE
        DO 13 I=1,12
          ZIDED(1,I)=ZIDE(1,I)
          ZDEL(I)=ZENGY(I)-ZRANGE(I-1)
          DO 14 J=2,12
            ZIDED(J,I)=ZIDE(J,I)-ZIDE(J-1,I)
14        CONTINUE
13      CONTINUE
        ZDEL(1)=0.
C
C  SET MEAN ENERGY OF REFLECTED PARTICLES FROM STOCHASTIC MATRIX
C
        E0AV(0)=0.
        DO 15 J=1,12
C  LAST BOX
          E0AV(J)=ZIDED(J,J)*(ZENGY(J)-ZDEL(J)/2.)
C   OTHER BOXES
          DO 16 I=1,J-1
16          E0AV(J)=E0AV(J)+ZIDED(I,J)*(ZRANGE(I)-ZDE(I)/2.)
15      CONTINUE
C
C  SET SOME CONSTANTS TO SPEED UP LINEAR INTERPOLATION IN
C  BEHRISCH REFLECTION DATA
C
        DO 17 J=0,11
          JP=J+1
          QUOTR(J)=(ZR(JP)-ZR(J))/(ZENGY(JP)-ZENGY(J))
          QUOTE(J)=(E0AV(JP)-E0AV(J))/(ZENGY(JP)-ZENGY(J))
17      CONTINUE
C
        IF (TRCREF) THEN
          CALL LEER(1)
          WRITE (iunout,*) 'REFLECTION DATA FROM BEHRISCH-MATRIX'
          WRITE (iunout,*) 
     .      'IMP. ENERGY (RED), REF. PROB, MEAN REFL. ENERGY'
          DO 19 J=0,12
            CALL MASR3('                        ',ZRANGE(J),ZR(J),
     .                                            E0AV(J))
19        CONTINUE
          CALL LEER(2)
        ENDIF
C
      ENDIF
C
C  PRINTOUT REFLECTION PROPERTIES OF SURFACES
C
      IF (TRCREF) THEN
        WRITE (iunout,*) 
     .    'ADDITIONAL SURFACES, THAT ARE NOT 100% RECYCLING'
        WRITE (iunout,*) 'FOR ALL SPECIES'
        ICOUNT=0
        DO 20 ILIM=1,NLIMI
          DO 21 ISP=1,NSPTOT
            IF ((RECYCT(ISP,ILIM).LT.1.D0).AND.
     .          (TRANSP(ISP,1,ILIM)+TRANSP(ISP,2,ILIM).LT.2.D0)) THEN
              ICOUNT=ICOUNT+1
              IF (ICOUNT.EQ.1) WRITE (iunout,*) 'ISPZ,ILIM,RECYCT'
              WRITE (iunout,*) TEXTS(ISP),ILIM,RECYCT(ISP,ILIM)
            ENDIF
21        CONTINUE
20      CONTINUE
        IF (ICOUNT.EQ.0) WRITE (iunout,*) 'NONE '
        WRITE (iunout,*) 
     .    'STANDARD SURFACES, THAT ARE NOT 100% REFLECTING'
        WRITE (iunout,*) 'FOR ALL SPECIES'
        ICOUNT=0
        DO 22 ISTS=1,NSTSI
          DO 23 ISP=1,NSPTOT
            IF ((RECYCT(ISP,NLIM+ISTS).LT.1.D0).AND.
     .          (TRANSP(ISP,1,NLIM+ISTS)+
     .           TRANSP(ISP,2,NLIM+ISTS).LT.2.D0)) THEN
              ICOUNT=ICOUNT+1
              IF (ICOUNT.EQ.1) WRITE (iunout,*) 'ISPZ,ISTS,RECYCT'
              WRITE (iunout,*) TEXTS(ISP),ISTS,RECYCT(ISP,NLIM+ISTS)
            ENDIF
23        CONTINUE
22      CONTINUE
        IF (ICOUNT.EQ.0) WRITE (iunout,*) 'NONE '
        ICOUNT=0
        CALL LEER(2)
      ENDIF
C
      CALL RF0USR
C
      RETURN
C
      ENTRY REFLC1 (WMIN,XMP,XCP,NPRIN,IGASF,IGAST)
C
C  SYNCHRONIZE RANDOM NUMBERS
C
      IF (NLCRR.AND.(NPANU.NE.NPANOLD)) THEN
C  INITIALIZE RANDOM NUMBERS FOR EACH PARTICLE, TO GENERATE CORRELATION
C       Call RANSET_EIRENE(ISEED)
        dummy=ranset_eirene(iseedR)
        DUMMY=RANF_EIRENE( )
        ISEEDR=ranget_eirene(isee)
        ISEEDR=INTMAX-ISEEDR
        NPANOLD=NPANU
      END IF
C
C  SURFACE NUMBER  : MSURF (MSURF=0: DEFAULT MODEL)
C  SPECIES INDEX   : ISPZ
C
      MODREF=ILREF(MSURF)
      XMW=ZNML(MSURF)
      XCW=ZNCL(MSURF)
      E0TERM=EWALL(MSURF)
      EBIND=EWBIN(MSURF)
      PRFCF=RECYCF(ISPZ,MSURF)
      PRFCT=RECYCT(ISPZ,MSURF)
      EXPP=EXPPL(ISPZ,MSURF)
      EXPE=EXPEL(ISPZ,MSURF)
      EXPI=EXPIL(ISPZ,MSURF)
      RINTG=RINTEG(MSURF)
      EINTG=EINTEG(MSURF)
      AINTG=AINTEG(MSURF)
      ISPZO=ISPZ
C
C  SET EMIN AND EMAX FOR ENERGY SAMPLING FROM DATABASE (MODREF=1)
C
      EMINR=E0TERM
      IF (E0TERM.LT.0.D0) EMINR=-2.*E0TERM
      EMAXR=E0
C
C   TENTATIVELY ASSUME  REFLECTION
      LGPART=.TRUE.
C   COSINE OF ANGLE OF INCIDENCE
      COSIN=VELX*CRTX+VELY*CRTY+VELZ*CRTZ
      IF (COSIN.LT.0.D0) GOTO 993
C
C   NO REFLECTION OF FAST ATOMS FOR INCIDENT ENERGY BELOW ERMIN
C                               OR IF IGASF=0
C
      IF (E0.LE.ERMIN.OR.IGASF.EQ.0) THEN
C
C   THERMAL PARTICLE MODEL IS CALLED
C
        RPROB=0.
        WFAC=0.
        COSIN=1.
C  RELATIVE FRACTION OF COSINE VS. SPECULAR REFLECTION
        F1=1.
        F2=0.
        FR1=RANF_EIRENE( )
C       IF (FR1.GE.RPROB) THEN
          IF (IGAST) 500,700,600
C       ENDIF
      ENDIF
C
C   FACTOR FOR CONVERSION TO REDUCED ENERGY
      EREDUC=EREDC(XMW,XCW,XMP,XCP)
C
C
C   MODREF=1: "DATABASE REFLECTION MODEL" (TRIM)
C   MODREF=2: "BEHRISCH-MATRIX"
C   MODREF=3: "USER SUPPLIED REFLECTION MODEL"
C
      IF (MODREF.EQ.1) THEN
        GOTO 100
      ELSEIF (MODREF.EQ.2) THEN
        GOTO 200
      ELSEIF (MODREF.GE.9) THEN
        CALL RF1USR (XMW,XCW,XMP,XCP,IGASF,IGAST,F1,F2,EXPI,
     .               RPROB,E0TERM,*400,*500,*600,*700)
        RETURN
      ELSE
        WRITE (6,*)  'INVALID REFLECTION MODEL PARAMETER '
        WRITE (6,*)  'EXIT CALLED FROM SUBROUTINE REFLEC.F'
        MSS=MSURF
        IF (MSURF.GT.NLIM) MSS=-(MSURF-NLIM)
        WRITE (6,*)  'MSURF, MODREF ',MSS, MODREF
        CALL EXIT_OWN(1)
      ENDIF
C
C  DATABASE REFLECTION MODEL STARTS HERE
C
100   CONTINUE
C
C   CHECK IF WALL REFLECTION DATA FOR IATM/IION INCIDENT ON
C   XWALL/ZWALL ARE AVAILABLE
C
      EQTO=1.D40
      EFCT=1.
      DO 120 IFILE=1,NFLR
        IF (ABS(ERDC(IFILE)-EREDUC).LE.EPS12) GOTO 130
        EQT=EREDUC/ERDC(IFILE)
        ETEST=ABS(EQT-1.)
        IF (ETEST.LT.EQTO) THEN
          ISAVE=IFILE
          EQTO=ETEST
          EQSAVE=EQT
        ENDIF
120   CONTINUE
      IF (ICOUNT.LT.5.AND.TRCREF) THEN
        WRITE (iunout,*) 'TRIM-REFLECTION DATA REQUESTED BUT NOT'
        WRITE (iunout,*) 'AVAILABLE FOR THE TARGET-PROJECTIL SYSTEM:'
        WRITE (iunout,*) 'XMWALL,XCWALL,XMPART,XCPART '
        WRITE (iunout,*)  XMW,XCW,XMP,XCP
        WRITE (iunout,*) 'EREDUC = ',EREDUC
        WRITE (iunout,*) 'THE REDUCED ENERGY FORMULAS ARE APPLIED WITH'
        WRITE (iunout,*) 'THE DATA FOR THE TARGET-PROJECTIL SYSTEM:'
        WRITE (iunout,*) 'J,WM(J),WC(J),TM(J),TC(J) '
        WRITE (iunout,*)  ISAVE,WM(ISAVE),WC(ISAVE),TM(ISAVE),TC(ISAVE)
        WRITE (iunout,*) 'ERDC(J),J=1,NFLR = ',(ERDC(J),J=1,NFLR)
        CALL LEER(1)
        ICOUNT=ICOUNT+1
      ENDIF
      IFILE=ISAVE
      EFCT=EQSAVE
C
      E0=E0*EFCT
C
130   CONTINUE
C
C  FIND INDICES FOR INCIDENT ENERGY AND ANGLE: INDE, INDW, R01, R02
C
      DO 102 I=2,INEM
        INDEP=I
        IF (E0.LE.ENAR(I)) GOTO 101
102   CONTINUE
      INDEP=INE
101   INDE=INDEP-1
C
      DO 103 I=2,INWM
         INDWP=I
         IF (COSIN.GE.WIAR(I)) GOTO 104
103      CONTINUE
      INDWP=INW
104   INDW=INDWP-1
C
      RO1=(E0-ENAR(INDE))*DENAR(INDE)
      RO2=(COSIN-WIAR(INDW))*DWIAR(INDW)
C
C  REFLECTION PROBALITY: RPROB
C
      IF (RINTG.GT.0.D0) THEN
        RPROB=MIN(PRFCT,RINTG)
      ELSEIF (RINTG.LT.0) THEN
        RPROB=1.D0
      ELSE
        RF1=HFTR0(INDE,INDW,IFILE)
        RF1=RF1+RO1*(HFTR0(INDEP,INDW,IFILE)-RF1)
        RF2=HFTR0(INDE,INDWP,IFILE)
        RF2=RF2+RO1*(HFTR0(INDEP,INDWP,IFILE)-RF2)
C
        RPROB=RF1+RO2*(RF2-RF1)
        RPROB=MIN(RPROB*PRFCF,PRFCT)
      ENDIF
C
C   DECIDE IF PARTICLE IS TO BE REFLECTED OR IF THE "THERMAL
C   PARTICLE-MODEL" IS CALLED
C
      WFAC=1.
      FR1=RANF_EIRENE( )
C  THERMAL PARTICLE MODEL
      IF (FR1.GE.RPROB) THEN
        IF (IGAST) 500,700,600
      ENDIF
C
C  SPECIES OF REFLECTED PARTICLE
      IF (IGASF.LT.1.OR.IGASF.GT.NATMI) GOTO 992
      IATM=IGASF
      ISPZ=NSPH+IATM
      ITYP=1
C
C  ENERGY OF REFLECTED PARTICLE
C
      ZEP1=RANF_EIRENE( )
      DO 105 I=2,INRM
        INDR1P=I
        IF (ZEP1.LE.RAAR(I)) GOTO 106
105   CONTINUE
      INDR1P=INR
106   INDR1=INDR1P-1
C
      RO3=(ZEP1-RAAR(INDR1))*DRAAR(INDR1)
C
      IF (EINTG.GT.0.D0) THEN
C  CONSTANT ENERGY REFLECTION COEFFICIENT
        E0=E0*EINTG
      ELSEIF (EINTG.LT.0.D0) THEN
C       E0=E0
C  E0 FROM MEAN ENERGY MODEL
      ELSE
C  E0 FROM STOCHASTIC MATRIX
        RF1=HFTR1(INDE,INDW,INDR1,IFILE)
        RF1=RF1+RO1*(HFTR1(INDEP,INDW,INDR1,IFILE)-RF1)
        RF2=HFTR1(INDE,INDWP,INDR1,IFILE)
        RF2=RF2+RO1*(HFTR1(INDEP,INDWP,INDR1,IFILE)-RF2)
        RF3=HFTR1(INDE,INDW,INDR1P,IFILE)
        RF3=RF3+RO1*(HFTR1(INDEP,INDW,INDR1P,IFILE)-RF3)
        RF4=HFTR1(INDE,INDWP,INDR1P,IFILE)
        RF4=RF4+RO1*(HFTR1(INDEP,INDWP,INDR1P,IFILE)-RF4)
C
        RFF1=RF1+RO2*(RF2-RF1)
        RFF2=RF3+RO2*(RF4-RF3)
C
        E0=RFF1+RO3*(RFF2-RFF1)
        E0=MAX(E0,EMINR)
        E0=MIN(E0,EMAXR)
      ENDIF
C
      E0=E0/EFCT
      VEL=RSQDVA(IATM)*SQRT(E0)
C
C  POLAR ANGLE OF REFLECTION
C
      IF (EXPI.EQ.0..OR.EXPI.GE.100.D0) THEN
        F1=1.
        F2=0.
        GOTO 400
      ENDIF
C
      ZEP1=RANF_EIRENE( )
      DO 107 I=2,INRM
        INDR2P=I
        IF (ZEP1.LE.RAAR(I)) GOTO 108
107   CONTINUE
      INDR2P=INR
108   INDR2=INDR2P-1
C
      RO4=(ZEP1-RAAR(INDR2))*DRAAR(INDR2)
C
      RF1=HFTR2(INDE,INDW,INDR1,INDR2,IFILE)
      RF1=RF1+RO1*(HFTR2(INDEP,INDW,INDR1,INDR2,IFILE)-RF1)
      RF2=HFTR2(INDE,INDWP,INDR1,INDR2,IFILE)
      RF2=RF2+RO1*(HFTR2(INDEP,INDWP,INDR1,INDR2,IFILE)-RF2)
      RF3=HFTR2(INDE,INDW,INDR1P,INDR2,IFILE)
      RF3=RF3+RO1*(HFTR2(INDEP,INDW,INDR1P,INDR2,IFILE)-RF3)
      RF4=HFTR2(INDE,INDWP,INDR1P,INDR2,IFILE)
      RF4=RF4+RO1*(HFTR2(INDEP,INDWP,INDR1P,INDR2,IFILE)-RF4)
      RF5=HFTR2(INDE,INDW,INDR1,INDR2P,IFILE)
      RF5=RF5+RO1*(HFTR2(INDEP,INDW,INDR1,INDR2P,IFILE)-RF5)
      RF6=HFTR2(INDE,INDWP,INDR1,INDR2P,IFILE)
      RF6=RF6+RO1*(HFTR2(INDEP,INDWP,INDR1,INDR2P,IFILE)-RF6)
      RF7=HFTR2(INDE,INDW,INDR1P,INDR2P,IFILE)
      RF7=RF7+RO1*(HFTR2(INDEP,INDW,INDR1P,INDR2P,IFILE)-RF7)
      RF8=HFTR2(INDE,INDWP,INDR1P,INDR2P,IFILE)
      RF8=RF8+RO1*(HFTR2(INDEP,INDWP,INDR1P,INDR2P,IFILE)-RF8)
C
      RFF1=RF1+RO2*(RF2-RF1)
      RFF2=RF3+RO2*(RF4-RF3)
      RFF3=RF5+RO2*(RF6-RF5)
      RFF4=RF7+RO2*(RF8-RF7)
C
      RFFF1=RFF1+RO3*(RFF2-RFF1)
      RFFF2=RFF3+RO3*(RFF4-RFF3)
C
      ZCPHI=RFFF1+RO4*(RFFF2-RFFF1)
C  LIMIT COSINE OF POLAR ANGLE TO 85. DEGREES
C  (I.E., 5 DEGREES AGAINST SURFACE TANGENTIAL PLANE)
      ZCPHI=MIN(0.999999_DP,MAX(0.08716_DP,ZCPHI))
      ZSPHI=SQRT(1.-ZCPHI*ZCPHI)
C
C  AZIMUTAL ANGLE OF REFLECTION
C
      ZEP1=RANF_EIRENE( )
      DO 109 I=2,INRM
         INDR3P=I
         IF (ZEP1.LE.RAAR(I)) GOTO 110
109      CONTINUE
      INDR3P=INR
110   INDR3=INDR3P-1
C
      RO5=(ZEP1-RAAR(INDR3))*DRAAR(INDR3)
C
      IF (INDW.EQ.1) THEN
        RF1=HFTR3F(INDR3)
        RF3=RF1
        RF5=RF1
        RF7=RF1
        RF9=HFTR3F(INDR3P)
        RF11=RF9
        RF13=RF9
        RF15=RF9
      ELSE
        RF1=HFTR3(INDE,INDW,INDR1,INDR2,INDR3,IFILE)
        RF1=RF1+RO1*(HFTR3(INDEP,INDW,INDR1,INDR2,INDR3,IFILE)-RF1)
        RF3=HFTR3(INDE,INDW,INDR1P,INDR2,INDR3,IFILE)
        RF3=RF3+RO1*(HFTR3(INDEP,INDW,INDR1P,INDR2,INDR3,IFILE)-RF3)
        RF5=HFTR3(INDE,INDW,INDR1,INDR2P,INDR3,IFILE)
        RF5=RF5+RO1*(HFTR3(INDEP,INDW,INDR1,INDR2P,INDR3,IFILE)-RF5)
        RF7=HFTR3(INDE,INDW,INDR1P,INDR2P,INDR3,IFILE)
        RF7=RF7+RO1*(HFTR3(INDEP,INDW,INDR1P,INDR2P,INDR3,IFILE)-RF7)
        RF9=HFTR3(INDE,INDW,INDR1,INDR2,INDR3P,IFILE)
        RF9=RF9+RO1*(HFTR3(INDEP,INDW,INDR1,INDR2,INDR3P,IFILE)-RF9)
        RF=HFTR3(INDE,INDW,INDR1P,INDR2,INDR3P,IFILE)
        RF11=RF+RO1*(HFTR3(INDEP,INDW,INDR1P,INDR2,INDR3P,IFILE)-RF)
        RF=HFTR3(INDE,INDW,INDR1,INDR2P,INDR3P,IFILE)
        RF13=RF+RO1*(HFTR3(INDEP,INDW,INDR1,INDR2P,INDR3P,IFILE)-RF)
        RF=HFTR3(INDE,INDW,INDR1P,INDR2P,INDR3P,IFILE)
        RF15=RF+RO1*(HFTR3(INDEP,INDW,INDR1P,INDR2P,INDR3P,IFILE)-RF)
      ENDIF
C
      RF2=HFTR3(INDE,INDWP,INDR1,INDR2,INDR3,IFILE)
      RF2=RF2+RO1*(HFTR3(INDEP,INDWP,INDR1,INDR2,INDR3,IFILE)-RF2)
      RF4=HFTR3(INDE,INDWP,INDR1P,INDR2,INDR3,IFILE)
      RF4=RF4+RO1*(HFTR3(INDEP,INDWP,INDR1P,INDR2,INDR3,IFILE)-RF4)
      RF6=HFTR3(INDE,INDWP,INDR1,INDR2P,INDR3,IFILE)
      RF6=RF6+RO1*(HFTR3(INDEP,INDWP,INDR1,INDR2P,INDR3,IFILE)-RF6)
      RF8=HFTR3(INDE,INDWP,INDR1P,INDR2P,INDR3,IFILE)
      RF8=RF8+RO1*(HFTR3(INDEP,INDWP,INDR1P,INDR2P,INDR3,IFILE)-RF8)
      RF10=HFTR3(INDE,INDWP,INDR1,INDR2,INDR3P,IFILE)
      RF10=RF10+RO1*(HFTR3(INDEP,INDWP,INDR1,INDR2,INDR3P,IFILE)-RF10)
      RF12=HFTR3(INDE,INDWP,INDR1P,INDR2,INDR3P,IFILE)
      RF12=RF12+RO1*(HFTR3(INDEP,INDWP,INDR1P,INDR2,INDR3P,IFILE)-RF12)
      RF14=HFTR3(INDE,INDWP,INDR1,INDR2P,INDR3P,IFILE)
      RF14=RF14+RO1*(HFTR3(INDEP,INDWP,INDR1,INDR2P,INDR3P,IFILE)-RF14)
      RF16=HFTR3(INDE,INDWP,INDR1P,INDR2P,INDR3P,IFILE)
      RF16=RF16+RO1*(HFTR3(INDEP,INDWP,INDR1P,INDR2P,INDR3P,IFILE)-RF16)
C
      RFF1=RF1+RO2*(RF2-RF1)
      RFF2=RF3+RO2*(RF4-RF3)
      RFF3=RF5+RO2*(RF6-RF5)
      RFF4=RF7+RO2*(RF8-RF7)
      RFF5=RF9+RO2*(RF10-RF9)
      RFF6=RF11+RO2*(RF12-RF11)
      RFF7=RF13+RO2*(RF14-RF13)
      RFF8=RF15+RO2*(RF16-RF15)
C
      RFFF1=RFF1+RO3*(RFF2-RFF1)
      RFFF2=RFF3+RO3*(RFF4-RFF3)
      RFFF3=RFF5+RO3*(RFF6-RFF5)
      RFFF4=RFF7+RO3*(RFF8-RFF7)
C
      RFFFF1=RFFF1+RO4*(RFFF2-RFFF1)
      RFFFF2=RFFF3+RO4*(RFFF4-RFFF3)
C
      ZCTHET=RFFFF1+RO5*(RFFFF2-RFFFF1)
      ZCTHET=MAX(-.999999_DP,MIN(0.999999_DP,ZCTHET))
      ZSTHET=SQRT(1.-ZCTHET*ZCTHET)
      ZSTHET=ZSTHET*SIGN(1._DP,(RANF_EIRENE( )-0.5_DP))
C
      VX=-ZCPHI
      VY=ZSPHI*ZSTHET
      VZ=ZSPHI*ZCTHET
      IF (COSIN.GT.0.999999) THEN
        CALL ROTATF (VELX,VELY,VELZ,VX,VY,VZ,CRTX,CRTY,CRTZ)
      ELSE
        CALL ROTATE (VELX,VELY,VELZ,VX,VY,VZ,CRTX,CRTY,CRTZ,COSIN)
      ENDIF
      RETURN
C
C  MODIFIED BEHRISCH MATRIX MODEL STARTS HERE
C
200   CONTINUE
C
      E0=E0*EREDUC
C
C  DETERMINE INTERVAL FOR INCIDENT ENERGY: IRM, ED
C
      DO 201 J=1,IDIM
        IRANGE=J
        IF (ZENGY(J).GE.E0) GO TO 202
201   CONTINUE
202   CONTINUE
      IRM=IRANGE-1
      ED=E0-ZENGY(IRM)
C
C   REFLECTION PROBABILITY FOR FAST PARTICLE REFLECTION MODEL: RPROB
C
      IF (RINTG.GT.0.D0) THEN
        RPROB=MIN(PRFCT,RINTG)
      ELSEIF (RINTG.LT.0.D0) THEN
        RPROB=1.D0
      ELSE
        PRBRF=MIN(1._DP,MAX(0._DP,ZR(IRM)+QUOTR(IRM)*ED))
        RPROB=1.-(1.-PRBRF)*(COSIN**EXPP)
        RPROB=MIN(RPROB*PRFCF,PRFCT)
      ENDIF
C
C  RELATIVE FRACTION OF COSINE VS. SPECULAR REFLECTION
      IF (EXPI.EQ.0.D0.OR.EXPI.GE.100.D0) THEN
        F1=1.
        F2=0.
      ELSE
        F1=MAX(0.015_DP,MIN(1._DP,COSIN**EXPI))
        F2=SQRT(1.-F1*F1)
      ENDIF
C
      WFAC=1.
      FR1=RANF_EIRENE( )
C
C  THERMAL PARTICLE MODEL
      IF (FR1.GE.RPROB) THEN
        IF (IGAST) 500,700,600
      ENDIF
C
C  FAST PARTICLE REFLECTION MODEL
C
C  SPECIES OF REFLECTED PARTICLE
      IATM=IGASF
      ISPZ=NSPH+IATM
      ITYP=1
C
C   ENERGY-REFLECTION COEFFICIENT
C   EPROB=1.-(1.-ERBRF)*(COSIN**EXPE)
C
      EFAC=COSIN**EXPE
      ESUM=E0-E0*EFAC
C
      IF (EINTG.GT.0.D0) THEN
        E0=E0*EINTG
C     ELSEIF (EINTG.LT.0.D0) THEN
C  E0 FROM MEAN ENERGY MODEL
C       E0=ESUM+(E0AV(IRM)+QUOTE(IRM)*ED)*EFAC
      ELSE
C  E0 FROM STOCHASTIC BEHRISCH MATRIX MODEL
C   REFLECTION ENERGY, "BEHRISCH MATRIX"
C   NUMBER OF BOXES IN THIS RANGE: IRANGE
C   DISTRIBUTION ZIDE(...,IRANGE)
C
        ZEP1=RANF_EIRENE( )
C
        DO 305 J=1,IRM
          IBOX=J
          ZDELTA=ZDE(J)
          ZE=ZRANGE(J)
          ZA=ZIDE(J,IRANGE)
          IF (ZA.GT.ZEP1) GO TO 307
305     CONTINUE
C  LAST BOX
        IBOX=IRANGE
        ZDELTA=ZDEL(IRANGE)
        ZE=ZENGY(IRANGE)
        ZA=1.
C
C   REFLECTION ENERGY, LINEAR INTERPOLATION
307     CONTINUE
        ZE0=ZE-(ZA-ZEP1)*ZDELTA/ZIDED(IBOX,IRANGE)
        ZE0=ZE0*E0/ZENGY(IRANGE)
        E0=ESUM+ZE0*EFAC
      ENDIF
C
C  E0 IS FOUND NOW. NEXT:
C  NEW WEIGHT, RESCALE ENERGY, SET VELOCITY
C
350   WEIGHT=WEIGHT*WFAC
      E0=E0/EREDUC
      VEL=RSQDVA(IATM)*SQRT(E0)
C     GOTO 400
C
400   CONTINUE
C
C  ANGULAR DISTRIBUTION
C
      IF (EXPI.LT.100.) THEN
        IF (F1.GT.0.999999) THEN
C  NO SPECULAR CONTRIBUTION (F2 = 0., F1 = 1.)
          IF (INIV4.LE.0) CALL FCOSIN
          VX=FC1(INIV4)
          VY=FC2(INIV4)
          VZ=FC3(INIV4)
          INIV4=INIV4-1
          CALL ROTATF (VELX,VELY,VELZ,VX,VY,VZ,CRTX,CRTY,CRTZ)
        ELSE
C  INCLUDE SPECULAR CONTRIBUTION (F2 > 0., F1 < 1.)
          ZTHET=PI2A*RANF_EIRENE( )
          ZSTHET=SIN(ZTHET)
          ZCTHET=COS(ZTHET)
          A=RANF_EIRENE( )
          ZCPHI=SQRT(A)
          ZSPHI=SQRT(1.-A)
C
          ZSPHI=ZSPHI*F1
          ZCPHI=SQRT(1.-ZSPHI*ZSPHI)
C
          VX=-ZCPHI*F1+        ZSPHI*ZSTHET*F2
          VY= ZSPHI*ZCTHET
          VZ= ZSPHI*ZSTHET*F1+ ZCPHI*F2
C
          CALL ROTATE (VELX,VELY,VELZ,VX,VY,VZ,CRTX,CRTY,CRTZ,COSIN)
        ENDIF
      ELSE
C   PURELY SPECULAR REFLECTION :EXPI .GE. 100 .
C   EXPI.GE.100 MEANS: INELASTIC+SPECULAR
        COSI2=-(COSIN+COSIN)
        VELX=VELX+COSI2*CRTX
        VELY=VELY+COSI2*CRTY
        VELZ=VELZ+COSI2*CRTZ
      ENDIF
      RETURN
C
C  "THERMAL MOLECULE MODEL"
C
C  CREATE MOLECULE OF SPECIES IMOL
C  WITH PROBABILITY PRFCT-RPROB, WHERE RPROB IS THE
C  PROBABILITY FOR BACKSCATTERING OF HOT ATOMS (.LE. PRFCT)
C  THE CONDITION FR1.GE.RPROB IS FULLFILLED AT THIS POINT
C
500   CONTINUE
      ITYP=2
      IMOL=-IGAST
      IF (IMOL.LT.1.OR.IMOL.GT.NMOLI) THEN
        FR2=RANF_EIRENE( )
        DO 501 I=1,NMOLI
          IMOL=I
          IF (FR2.LE.DMOL(IMOL)) GOTO 502
501     CONTINUE
        GOTO 992
502     CONTINUE
      ENDIF
      ISPZ=NSPA+IMOL
C
C  FAST FRACTION
C     RPROBF=RPROB
C  THERMAL MOLECULE FRACTION
      RPROBM=PRFCT-RPROB
C  LOST FRACTION
      RPROBL=1.D0-PRFCT
C
      IF (WEIGHT.LT.WMIN.OR.RPROBM.LE.0.D0) THEN
C  NO SUPRESSION OF ABSORPTION
        PRTEST=RPROB+RPROBM
C  AT THIS POINT: 1.D0.GE.FR1.GE.RPROB
        IF (FR1.GT.PRTEST) GOTO 700
      ELSE
C  SUPRESSION OF ABSORPTION
        WMOLEC=RPROBM/(1.D0-RPROB)
        WLOSS =RPROBL/(1.D0-RPROB)
        IF (WLOSS.GT.0.D0) THEN
          WABS=WEIGHT*WLOSS
          IF (MSURF.GT.0) SPUMP(ISPZO,MSURF)=SPUMP(ISPZO,MSURF)+WABS
        ENDIF
        WEIGHT=WEIGHT*WMOLEC
      ENDIF
C
C  NUMBER OF MOLECULES PER INCIDENT PARTICLE
C  NOTE: ABSORPTION DUE TO RECOMBINATION OF ATOMS (ONLY A FRACTION OF
C  A MOLECULE IS RE-EMITTED PER INCIDENT ATOM) IS ALWAYS SUPRESSED
C
      FLPRT=DBLE(NPRIN)/DBLE(NPRT(ISPZ))
      WEIGHT=WEIGHT*FLPRT
C
C  REFLECT THERMAL MOLECULE
      IF (E0TERM.GT.0.D0) THEN
C  MONOENERGETIC, E0 (EV),  COSINE
        E0=E0TERM
        VEL=RSQDVM(IMOL)*SQRT(E0)
        F1=1.
        GOTO 400
      ELSEIF (E0TERM.LT.0.D0) THEN
C  SAMPLE FROM MAXWELLIAN FLUX AROUND INNER (!) NORMAL AT TEMP. TW (EV)
        TW=-E0TERM
        CALL VELOCS (TW,0._DP,0._DP,0._DP,0._DP,0._DP,RSQDVM(IMOL),
     .                CVRSSM(IMOL),
     .               -CRTX,-CRTY,-CRTZ,
     .               E0,VELX,VELY,VELZ,VEL)
      ELSE
        GOTO 991
      ENDIF
      RETURN
C
C  "THERMAL ATOM MODEL"
C
C    ONE ATOM IS BORN,
C    WITH PROBABILITY PRFCT-RPROB, WHERE RPROB IS THE
C    PROBABILITY FOR BACKSCATTERING OF HOT ATOMS (.LE. PRFCT)
C    THE CONDITION FR1.GE.RPROB IS FULLFILLED AT THIS POINT
C
C    E0TERM > 0: COSINE DISTRIBUTED, E0=E0TERM,
C    E0TERM < 0: MAXWELLIAN AT TEMP. T=-E0TERM
C    E0TERM = 0: THOMPSON DISTRIBUTION WITH SURF. BIND. EN.= EBIND
C                UNTIL NOW: ONLY FOR THERMAL ATOM REFLECTION MODEL
C
600   CONTINUE
      ITYP=1
      IATM=IGAST
      IF (IATM.GT.NATMI) THEN
        FR2=RANF_EIRENE( )
        DO 610 I=1,NATMI
          IATM=I
          IF (FR2.LE.DATM(IATM)) GOTO 611
610     CONTINUE
        GOTO 992
611     CONTINUE
      ENDIF
      ISPZ=NSPH+IATM
C
C  FAST FRACTION
C     RPROBF=RPROB
C  THERMAL ATOM FRACTION
      RPROBA=PRFCT-RPROB
C  LOST FRACTION
      RPROBL=1.D0-PRFCT
C
      IF (WEIGHT.LT.WMIN.OR.RPROBA.LE.0.D0) THEN
C  NO SUPRESSION OF ABSORPTION
        PRTEST=RPROB+RPROBA
C  AT THIS POINT: 1.D0.GE.FR1.GE.RPROB
        IF (FR1.GE.PRTEST) GOTO 700
      ELSE
C  SUPRESSION OF ABSORPTION
        WATOM=RPROBA/(1.D0-RPROB)
        WLOSS=RPROBL/(1.D0-RPROB)
        IF (WLOSS.GT.0.D0) THEN
          WABS=WEIGHT*WLOSS
          IF (MSURF.GT.0) SPUMP(ISPZO,MSURF)=SPUMP(ISPZO,MSURF)+WABS
        ENDIF
        WEIGHT=WEIGHT*WATOM
      ENDIF
C
C  REFLECT THERMAL ATOM
      IF (E0TERM.GT.0.D0) THEN
C  MONOENERGETIC, E0 (EV), +  STANDARD, COSINE LIKE
        E0=E0TERM
        E0_MEAN=E0TERM
        VEL=RSQDVA(IATM)*SQRT(E0)
        F1=1.
        GOTO 400
      ELSEIF (E0TERM.LT.0.D0) THEN
C  SAMPLE FROM MAXWELLIAN FLUX AROUND INNER (!) NORMAL AT TEMP. TW (EV)
        TW=-E0TERM
        CALL VELOCS (TW,0._DP,0._DP,0._DP,0._DP,0._DP,RSQDVA(IATM),
     .                CVRSSA(IATM),
     .               -CRTX,-CRTY,-CRTZ,
     .               E0,VELX,VELY,VELZ,VEL)
        RETURN
      ELSEIF (E0TERM.EQ.0.D0) THEN
C  SAMPLE FROM ENERGY FROM THOMPSON DISTRIBUTION + STAND. ANGULAR DISTR.
        E0=FTHOMP(EBIND,EMAXR)
        VEL=RSQDVA(IATM)*SQRT(E0)
        F1=1.
        GOTO 400
      ENDIF
C
C  ABSORB PARTICLE AT THIS SURFACE
C
700   CONTINUE
      IF (MSURF.GT.0) SPUMP(ISPZO,MSURF)=SPUMP(ISPZO,MSURF)+WEIGHT
      LGPART=.FALSE.
      WEIGHT=0.
      ITYP=-1
      RETURN
C
C  ERROR MESSAGES FROM SUBR. REFLEC
C
991   CONTINUE
      WRITE (iunout,*) 'ERROR IN SUBR. REFLEC '
      MSS=MSURF
      IF (MSS.GT.NLIM) MSS=-(MSURF-NLIM)
      WRITE (iunout,*) 'MSURF = ',MSS
      WRITE (iunout,*) 'E0TERM=0 '
      WRITE (iunout,*) 'STOP HISTORY NO. NPANU= ',NPANU
      GOTO 999
C
992   CONTINUE
      WRITE (iunout,*) 'ERROR IN SUBR. REFLEC '
      MSS=MSURF
      IF (MSS.GT.NLIM) MSS=-(MSURF-NLIM)
      WRITE (iunout,*) 'MSURF = ',MSS
      WRITE (iunout,*) 'IGASF, IGAST ?? '
      WRITE (iunout,*) 'STOP HISTORY NO. NPANU= ',NPANU
      GOTO 999
c
993   CONTINUE
      WRITE (iunout,*) 'ERROR IN SUBR. REFLEC '
      MSS=MSURF
      IF (MSS.GT.NLIM) MSS=-(MSURF-NLIM)
      WRITE (iunout,*) 'MSURF = ',MSS
      WRITE (iunout,*) 'COSIN.LT.0. ', COSIN
      WRITE (iunout,*) 'STOP HISTORY NO. NPANU= ',NPANU
      GOTO 999
C
999   IF (NLTRC)  CALL CHCTRC(X0,Y0,Z0,16,18)
      LGPART=.FALSE.
      WEIGHT=0.
      RETURN
C

C     The following ENTRY is for reinitialization of EIRENE (DMH)
      
      ENTRY REFLEC_REINIT
      ICOUNT = 0
      NPANOLD = 0
      END
