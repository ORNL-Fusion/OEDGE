!pb  100107 ENTRY SIGHA_REINIT added
CDR  parameter PEN introduced, to identify hydrogen line by central energy
C
C
      SUBROUTINE SIGHA(INIT,JJJ,ZDS,PEN,PSIG,DUMMY2,ARGST)
C
C  INPUT:
C          INIT: FLAG FOR INITIALISATION (DO NOT CHANGE!)
C          NCELL (COMPRT): INDEX IN TALLY ARRAYS FOR CURRENT ZONE
C          JJJ:    INDEX OF SEGMENT ALONG CHORD
C          ZDS:    LENGTH OF SEGMENT NO. JJJ
C          PEN:    CENTRAL ENERGY OF LINE (EV)
C  OUTPUT: CONTRIB. FROM CELL NCELL AND CHORD SEGMENT JJJ TO:
C          THE H LINE FLUX PSIG(I),I=0,5 CONTRIBUTIONS
C          FROM ATOMS, MOLECULES, TEST IONS, BULK IONS AND NEGATIV IONS
C          THE INTEGRANT ARGST SUCH THAT INTEGR.(ARGST*DL) = PSIG
C
      USE PRECISION
      USE PARMMOD
      USE CESTIM
      USE CGRID
      USE CGEOM
      USE COMPRT
      USE COMUSR

      IMPLICIT NONE

      INTEGER, INTENT(IN) :: INIT, JJJ
      REAL(DP), INTENT(IN) :: ZDS, DUMMY2, PEN
      REAL(DP), INTENT(IN OUT) :: PSIG(0:NSPZ+10), ARGST(0:NSPZ+10,NRAD)
      INTEGER :: ISTOLD, ISP, NCELC, ICELL, ITROLD
      DATA ISTOLD/-1/
      DATA ITROLD/-1/
C
      SAVE
C
c     WRITE (IUNOUT,*) 'SIGHA,INIT,PEN,ISTRA ',
c    .                  INIT,PEN,ISTRA,ISTOLD,IITER,ITROLD
      IF (INIT.EQ.0) THEN
        DO 100 ISP=0,NSPZ+10
          PSIG(ISP)=0.
          DO 100 ICELL=1,NSBOX
            ARGST(ISP,ICELL)=0.
100     CONTINUE
C  INITIALISE H-LINE ARRAYS FOR CURRENT STRATUM ?
        IF ((ISTRA .NE. ISTOLD) .OR. (IITER .NE. ITROLD)) then
          if (PEN.EQ.12.089_DP) THEN
            CALL Ly_beta(ISTRA,NADVI+1,NADVI+2,NADVI+3,NADVI+4,NADVI+5,
     .                   NADVI+6)
          elseif (PEN.EQ.2.8560_DP) THEN
            CALL Ba_gamma(ISTRA,NADVI+1,NADVI+2,NADVI+3,NADVI+4,NADVI+5,
     .                    NADVI+6)
          else !  default: H-alpha line. Also: PEN=1.8889
            CALL Ba_alpha(ISTRA,NADVI+1,NADVI+2,NADVI+3,NADVI+4,NADVI+5,
     .                    NADVI+6)
          endif
        endif
        ISTOLD=ISTRA
        ITROLD=IITER
        RETURN
      ENDIF
C
C  LINE INTEGRAL: PHOTONS/SEC/CM**2
C
      IF (NSPZ+2.LT.6) THEN
        WRITE (iunout,*) 'ERROR EXIT FROM SIGHA '
        CALL EXIT_OWN(1)
      ENDIF
C
      ncelc=ncltal(ncell)
      PSIG(1)=PSIG(1)+ZDS*ADDV(NADVI+1,NCELC)
      PSIG(2)=PSIG(2)+ZDS*ADDV(NADVI+2,NCELC)
      PSIG(3)=PSIG(3)+ZDS*ADDV(NADVI+3,NCELC)
      PSIG(4)=PSIG(4)+ZDS*ADDV(NADVI+4,NCELC)
      PSIG(5)=PSIG(5)+ZDS*ADDV(NADVI+5,NCELC)
      PSIG(0)=PSIG(0)+ZDS*ADDV(NADVI+6,NCELC)
      ARGST(1,JJJ)=ADDV(NADVI+1,NCELC)
      ARGST(2,JJJ)=ADDV(NADVI+2,NCELC)
      ARGST(3,JJJ)=ADDV(NADVI+3,NCELC)
      ARGST(4,JJJ)=ADDV(NADVI+4,NCELC)
      ARGST(5,JJJ)=ADDV(NADVI+5,NCELC)
      ARGST(0,JJJ)=ADDV(NADVI+6,NCELC)
C
      RETURN

C     Following lines for reinitialisation of eirene (DMH)

      ENTRY SIGHA_REINIT
      ISTOLD = -1
      ITROLD = -1
      RETURN
      END
