*DK DIAGNO
C
C  CALLED IN POST PROCESSING PHASE:
C  CALCULATE A NUMBER OF (ICHORI=1,NCHORI) LINE INTEGRALS ALONG LINES-OF-SIGHT
C  USING THE INPUT DATA OF INPUT BLOCK 12, AND THE INPUT AND OUTPUT
C  TALLIES FROM THE EIRENE RUN.
C  THE LINE INTEGRALS CAN BE TOTAL EMISSIVITIES, OR THEY CAN HAVE
C  HAVE A SPECTRAL RESOLUTION (ENERGY-RESOLUTION), DEPENDING ON THE VALUE
C  OF INPUT FLAG NCHENI(ICHORD).
C  THIS ROUTINE SETS THE ENERGY ARRAYS AND THEN CALLS SUBR. SGNAL FOR
C  EACH LINE OF SIGHT ICHORI, THE SELECTED STRATUM ISTR AND THE SELECTED
C  INDEX OF THE TEST PARTICLE SPECIES ISP
C  AFTER ALL LINES OF SIGHT ARE DONE, THE OUTPUT ROUTINE OUTSIG IS CALLED
C  FOR PRINTING AND PLOTTING.
C
      SUBROUTINE DIAGNO

      USE PRECISION
      USE PARMMOD
      USE COMUSR
      USE CLOGAU
      USE CPLOT
      USE COMSIG
      USE CTRCEI
      USE COMPRT, ONLY: IUNOUT

      IMPLICIT NONE

      REAL(DP) :: ENSAVE(NCHOR,NCHEN)
      REAL(DP) :: EN, EQUOT, FMXENM, ALEMX, ALEMN
      INTEGER :: J, ISTR, ISP, NCHNI, ICHORI
      LOGICAL :: PLSAVE,L_CHOR(NCHOR)
C
C  INITIALISE LINE INTEGRATION ROUTINE
C

      PLSAVE=PLHST
      PLHST=PLCHOR
C
      NSPNEW(1)=1
      NCHNI=IABS(NCHENI)
      FMXENM=DBLE(NCHNI-1)
C
C  SET ENERGY ARRAY IN CASE OF SPECTRALLY RESOLVED LINE INTEGRATED
C
      IF (NCHORI.GT.0) THEN
      CALL LEER(2)
      CALL HEADNG('DIAGNOSTICS MODULE (LINE-OF-SIGHT-INTEGRATION)',46)
      ENDIF

      DO 100 ICHORI=1,NCHORI

        CALL LEER(1)
        WRITE (IUNOUT,*) 'CHORD NO. ',ICHORI
        IF (NCHENI.LT.-1) THEN
C  LOG. ENERGY SCALE
          ALEMN=LOG10(EMIN1(ICHORI))
          ALEMX=LOG10(EMAX1(ICHORI))
          EQUOT=(ALEMX-ALEMN)/FMXENM
          DO 10 J=1,NCHNI
            EN=ALEMN+(J-1)*EQUOT
            ENERGY(J)=10.**EN
10          ENSAVE(ICHORI,J)=ENERGY(J)
        ELSEIF (NCHENI.GT.1) THEN
C  LIN. ENERGY SCALE
          EQUOT=(EMAX1(ICHORI)-EMIN1(ICHORI))/FMXENM
          DO 20 J=1,NCHNI
            ENERGY(J)=EMIN1(ICHORI)+(J-1)*EQUOT
20          ENSAVE(ICHORI,J)=ENERGY(J)
        ELSEIF (NCHENI.EQ.1) THEN
C  NO ENERGY DEPENDENCE
          NCHNI=1
          ENERGY(1)=EMIN1(ICHORI)
          ENSAVE(ICHORI,1)=ENERGY(1)
        ELSEIF (NCHENI.EQ.0) THEN
C  NO CALL TO SUBR. SGNAL
          WRITE (IUNOUT,*) 'NO LOS SIGNALS COMPUTED, BECAUSE NCHENI = 0'
          L_CHOR(ICHORI)=.FALSE.
          GOTO 100
        ENDIF
C
C  CARRY OUT LINE INTEGRATION
C
        ISTR=NSPSTR(ICHORI)
        ISP=NSPSPZ(ICHORI)
C  TENTATIVELY ASSUME: THIS LINE OF SIGHT IS ACTIVE
        L_CHOR(ICHORI)=.TRUE.
        CALL SGNAL(ICHORI,ISTR,ISP,L_CHOR(ICHORI))
C
100   CONTINUE
C
C  OUTPUT
C
      IF (NCHNI.NE.0) CALL OUTSIG(ENSAVE,L_CHOR)
C
      PLHST=PLSAVE
      RETURN
      END
