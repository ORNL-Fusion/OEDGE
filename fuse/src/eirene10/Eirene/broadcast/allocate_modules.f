

      SUBROUTINE ALLOCATE_MODULES
      USE PRECISION
      USE PARMMOD
      USE CESTIM
      USE CREFMOD
      USE COMUSR
      USE CADGEO
      USE CAI
      USE CCONA
      USE CLOGAU
      USE CINIT
      USE COMSIG
      USE CPOLYG
      USE CGRID
      USE CZT1
      USE CTRCEI
      USE CCOUPL
      USE CGEOM
      USE CSDVI
      USE CSDVI_BGK
      USE CSDVI_COP
      USE CTETRA
      USE COMPRT
      USE CPES
      USE COMNNL
      USE COMSOU
      USE CSTEP
      USE COMSPL
      USE CTEXT
      USE CLGIN
      USE COUTAU
      USE COMXS
      USE CTRIG
      USE BRAEIR
      USE EIRBRA
      USE CLAST
      USE CPLOT
      USE CREF
      USE CSPEI
      USE CSPEZ
      USE CUPD
      IMPLICIT NONE

      CALL ALLOC_CESTIM(1)
!pb      CALL ALLOC_CESTIM(2)
      CALL ALLOC_CREFMOD
      CALL ALLOC_COMUSR(1)
      CALL ALLOC_COMUSR(2)
      CALL ALLOC_COMUSR(3)
      CALL ALLOC_CADGEO
      CALL ALLOC_CAI
      CALL ALLOC_CCONA
      CALL ALLOC_CLOGAU
      CALL ALLOC_CINIT
      CALL ALLOC_COMSIG
      CALL ALLOC_CPOLYG
      CALL ALLOC_CGRID
      CALL ALLOC_CZT1(1)
      CALL ALLOC_CZT1(2)
      CALL ALLOC_CTRCEI
      IF (NMODE .NE. 0) CALL ALLOC_CCOUPL(1)
      CALL ALLOC_CCOUPL(2)
      CALL ALLOC_CGEOM(1)
      CALL ALLOC_CGEOM(2)
      CALL ALLOC_CSDVI(1)
      CALL ALLOC_CSDVI(2)
      CALL ALLOC_CSDVI_BGK
      CALL ALLOC_CSDVI_COP
      CALL ALLOC_CTETRA
      CALL ALLOC_COMPRT
      CALL ALLOC_CPES
      CALL ALLOC_COMNNL
      CALL ALLOC_COMSOU(1)
      CALL ALLOC_COMSOU(2)
      CALL ALLOC_CSTEP
      CALL ALLOC_COMSPL
      CALL ALLOC_CTEXT(1)
      CALL ALLOC_CTEXT(2)
      CALL ALLOC_CLGIN
      CALL ALLOC_COUTAU
      CALL ALLOC_COMXS(1)
      CALL ALLOC_COMXS(2)
      CALL ALLOC_CTRIG

      CALL ALLOC_BRAEIR (NDX,NDY,NFL)
      CALL ALLOC_EIRBRA (NDX,NDY,NFL,NSTRA)
      CALL ALLOC_CLAST
      CALL ALLOC_CPLOT
      CALL ALLOC_CREF
      CALL ALLOC_CSPEI
      CALL ALLOC_CSPEZ
      CALL ALLOC_CUPD

!  allocate and initialize storage for trajectories 
      IF (.NOT.ALLOCATED(TRAJ)) THEN
        ALLOCATE (TRAJ(NCHOR+NTRJ))

        DO ITRJ = 1, NCHOR+NTRJ
          ALLOCATE(TRAJ(ITRJ)%TRJ)
          TRAJ(ITRJ)%TRJ%NCOU_CELL = 0
          NULLIFY(TRAJ(ITRJ)%TRJ%CELLS)
        END DO
      END IF

      RETURN
      END SUBROUTINE ALLOCATE_MODULES
